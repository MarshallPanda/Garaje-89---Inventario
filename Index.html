<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garaje '89 | Sistema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* --- TEMA OSCURO GARAJE '89 --- */
        :root { 
            --neon: #39ff14; 
            --dark: #121212; 
            --panel: #1e1e1e; 
            --border: #333; 
        }
        body { background-color: var(--dark); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; margin:0; }
        
        /* PANTALLA DE CARGA */
        #loader { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); z-index:99999; 
            display:flex; justify-content:center; align-items:center; 
            color:var(--neon); font-size:1.5rem; flex-direction:column;
        }
        
        /* INPUTS Y BOTONES */
        .input-neon { 
            background: #000; border: 1px solid var(--border); color: white; 
            padding: 12px; width: 100%; border-radius: 4px; box-sizing: border-box;
        }
        .input-neon:focus { outline: none; border-color: var(--neon); }
        
        .btn-neon { 
            background: var(--neon); color: black; font-weight: bold; border: none; 
            padding: 12px; width: 100%; border-radius: 4px; cursor: pointer; transition: 0.3s; 
            text-transform: uppercase;
        }
        .btn-neon:hover { box-shadow: 0 0 15px var(--neon); transform: scale(1.02); }
        
        /* UTILIDADES */
        .oculto { display: none !important; }

        /* SIDEBAR (MENÃš) */
        .sidebar { 
            position: fixed; height: 100vh; width: 250px; background: #0a0a0a; 
            border-right: 1px solid var(--border); padding-top: 20px; z-index: 1000; 
        }
        .brand { 
            color: var(--neon); text-align: center; font-size: 1.8rem; 
            font-weight: bold; margin-bottom: 30px; letter-spacing: 2px; 
            text-shadow: 0 0 5px var(--neon); 
        }
        .nav-item { 
            padding: 15px 20px; color: #888; cursor: pointer; 
            display: flex; gap: 10px; transition: 0.3s; 
        }
        .nav-item:hover, .nav-item.active { 
            color: var(--neon); background: rgba(57,255,20,0.05); 
            border-left: 4px solid var(--neon); 
        }
        
        /* CONTENIDO PRINCIPAL */
        .main-content { margin-left: 250px; padding: 30px; }
        
        .card-panel { 
            background: var(--panel); padding: 25px; border-radius: 10px; 
            border: 1px solid var(--border); margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
        }
        
        /* TABLAS */
        .table-custom { width: 100%; color: #ccc; border-collapse: collapse; }
        .table-custom th { color: var(--neon); text-align: left; padding: 12px; border-bottom: 1px solid #444; }
        .table-custom td { padding: 12px; border-bottom: 1px solid #222; }
        .table-custom tr:hover { background: rgba(255,255,255,0.05); }

        /* LOGIN */
        .login-overlay { 
            position: fixed; width: 100%; height: 100%; background: #000; 
            z-index: 2000; display: flex; justify-content: center; align-items: center; 
        }
        .login-box { 
            background: var(--panel); padding: 40px; border-radius: 12px; 
            width: 380px; border: 1px solid var(--border); text-align: center; 
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.15); 
        }

        /* TEXTOS */
        .stat-val { font-size: 2.5rem; font-weight: bold; color: white; }
        .text-neon { color: var(--neon); }

        @media print { 
            .sidebar, .login-overlay, .no-print, #loader { display: none; } 
            .main-content { margin: 0; } 
            body { background: white; color: black; } 
        }
    </style>
</head>
<body>

    <div id="loader" class="oculto">
        <div class="spinner-border text-success" role="status"></div>
        <span class="mt-3">Conectando con Google Sheets...</span>
    </div>

    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2 class="brand">GARAJE '89</h2>
            <select id="login-user" class="input-neon mb-3">
                <option>Cargando usuarios...</option>
            </select>
            <input type="password" id="login-pass" class="input-neon mb-3" placeholder="ContraseÃ±a">
            <button onclick="login()" class="btn-neon">ACCEDER AL SISTEMA</button>
            <p id="login-error" class="text-danger mt-3 small"></p>
        </div>
    </div>

    <div id="app-container" class="oculto">
        
        <div class="sidebar no-print">
            <div class="brand">GARAJE '89</div>
            <div class="nav-item active" onclick="nav('pos', this)"><i class="bi bi-cart"></i> Vender</div>
            <div class="nav-item" onclick="nav('entrada', this)"><i class="bi bi-box-arrow-in-down"></i> Entradas</div>
            <div class="nav-item" onclick="nav('inv', this)"><i class="bi bi-box-seam"></i> Inventario</div>
            
            <div class="admin-only">
                <hr style="border-color:#333; margin:15px 20px">
                <div class="nav-item" onclick="nav('dash', this)"><i class="bi bi-graph-up"></i> Dashboard</div>
                <div class="nav-item" onclick="nav('ventas', this)"><i class="bi bi-journal-text"></i> Historial</div>
                <div class="nav-item" onclick="nav('users', this)"><i class="bi bi-people"></i> Usuarios</div>
            </div>
            
            <div style="position: absolute; bottom: 20px; width: 100%; text-align: center;">
                <small id="user-display" style="color: #666; font-size: 0.8rem;"></small><br>
                <button onclick="location.reload()" class="btn btn-sm btn-outline-danger mt-2" style="border-color: #555; color: #888;">Cerrar SesiÃ³n</button>
            </div>
        </div>

        <div class="main-content">
            
            <div id="sec-pos" class="view-section">
                <h3 class="mb-4 text-neon">PUNTO DE VENTA</h3>
                <div class="card-panel">
                    <input id="scanner" class="input-neon" style="font-size:1.3rem" placeholder="ðŸ”« Escanear producto para vender..." autofocus>
                </div>
                <div class="card-panel">
                    <table class="table-custom">
                        <thead><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th><th></th></thead>
                        <tbody id="cart-body"></tbody>
                    </table>
                    <div class="mt-4 pt-3 border-top border-secondary text-end">
                        <h1 class="text-neon">S/ <span id="total-lbl">0.00</span></h1>
                        <button onclick="finalizar('venta')" class="btn-neon mt-2" style="max-width: 250px;">CONFIRMAR VENTA</button>
                    </div>
                </div>
            </div>

            <div id="sec-entrada" class="view-section oculto">
                <h3 class="mb-4 text-neon">ENTRADAS DE STOCK</h3>
                <div class="card-panel text-center py-5">
                    <i class="bi bi-box-seam text-neon" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 mb-4">Escanea para sumar +1 al inventario</h5>
                    <input id="scanner-entrada" class="input-neon mx-auto" style="font-size:1.5rem; text-align:center; max-width:500px" placeholder="CÃ³digo aquÃ­...">
                    <h4 id="msg-entrada" class="mt-4 text-secondary">Esperando cÃ³digo...</h4>
                </div>
            </div>

            <div id="sec-inv" class="view-section oculto">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-neon m-0">INVENTARIO</h3>
                    <button class="btn-neon" style="width:auto" onclick="modalNuevo('')">+ Nuevo Producto</button>
                </div>
                <div class="card-panel">
                    <div class="d-flex gap-2 mb-3">
                        <select id="filtro-prov" class="input-neon" onchange="filtrarInv()">
                            <option value="TODOS">Cargando...</option>
                        </select>
                        <button class="btn-neon" style="width:auto; background:#333; color:white; border:1px solid #555" onclick="cargarInv()">ðŸ”„</button>
                    </div>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <table class="table-custom">
                            <thead><th>Cod</th><th>Nombre</th><th>Prov</th><th>Stock</th><th>Precio</th></thead>
                            <tbody id="inv-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sec-dash" class="view-section oculto">
                <h3 class="mb-4 text-neon">DASHBOARD</h3>
                <div class="row g-4">
                    <div class="col-md-6"><div class="card-panel text-center"><h5>Ventas Totales</h5><div class="stat-val text-neon">S/ <span id="d-hist">0.00</span></div></div></div>
                    <div class="col-md-6"><div class="card-panel text-center"><h5>Ventas Hoy</h5><div class="stat-val text-neon">S/ <span id="d-hoy">0.00</span></div></div></div>
                </div>
            </div>

            <div id="sec-ventas" class="view-section oculto">
                <h3 class="mb-4 text-neon">HISTORIAL DE VENTAS</h3>
                <button class="btn-neon mb-3" style="width:auto" onclick="cargarVentas()">Actualizar Tabla</button>
                <div class="card-panel">
                    <table class="table-custom"><thead><th>Fecha</th><th>Vend</th><th>Prod</th><th>Total (Edit)</th><th></th></thead><tbody id="ventas-body"></tbody></table>
                </div>
            </div>

            <div id="sec-users" class="view-section oculto">
                <h3 class="mb-4 text-neon">GESTIÃ“N DE USUARIOS</h3>
                <div class="card-panel" style="max-width:450px">
                    <input id="u-id" class="input-neon mb-3" placeholder="ID Usuario (ej: juan)">
                    <input id="u-nom" class="input-neon mb-3" placeholder="Nombre Completo">
                    <input id="u-pass" class="input-neon mb-3" type="password" placeholder="ContraseÃ±a">
                    <label class="text-secondary mb-1 small">Rol de Acceso</label>
                    <select id="u-rol" class="input-neon mb-4"><option value="trabajador">Trabajador (Ventas/Inv)</option><option value="admin">Administrador (Total)</option></select>
                    <button class="btn-neon" onclick="crearUser()">REGISTRAR USUARIO</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="login-overlay oculto" style="background:rgba(0,0,0,0.95)">
        <div class="login-box" style="text-align:left; max-width:550px">
            <h4 class="text-neon text-center mb-4 pb-2 border-bottom border-secondary">REGISTRAR PRODUCTO</h4>
            
            <div class="row g-2 mb-3">
                <div class="col-12"><label class="small text-secondary">CÃ³digo</label><input id="n-codigo" class="input-neon" readonly style="background:#222; color:#777"></div>
                <div class="col-12"><label class="small text-secondary">Nombre</label><input id="n-nombre" class="input-neon"></div>
                <div class="col-12">
                    <label class="small text-secondary">Proveedor</label>
                    <select id="n-prov" class="input-neon" onchange="checkOtro(this)"></select>
                    <input id="n-prov-txt" class="input-neon mt-2 oculto" placeholder="Nuevo proveedor...">
                </div>
                <div class="col-6"><label class="small text-secondary">Costo</label><input id="n-costo" type="number" class="input-neon"></div>
                <div class="col-6"><label class="small text-secondary">Precio Venta</label><input id="n-precio" type="number" class="input-neon"></div>
                <div class="col-12"><label class="small text-secondary">Stock Inicial</label><input id="n-stock" type="number" class="input-neon" value="1"></div>
            </div>
            
            <div class="d-flex gap-2 mt-4">
                <button class="btn-neon" style="background:transparent; border:1px solid #555; color:#aaa" onclick="cerrarModal()">CANCELAR</button>
                <button class="btn-neon" onclick="guardarNuevo()">GUARDAR</button>
            </div>
        </div>
    </div>

<script>
    // --- âœ… TU API DE GOOGLE APPS SCRIPT ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyxBQpIK46_VtCiXmtOwsnQvhGM_OIy2k0lM5_KfROrzjJIMHhPSeDq_ZZiHQXJsCY/exec";

    // --- CONFIGURACIÃ“N FIREBASE (TUS DATOS REALES) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBzUErnjQEGE9-neDh5z6VJ_xNaHRmAkew",
        authDomain: "garaje89-inventario.firebaseapp.com",
        projectId: "garaje89-inventario",
        storageBucket: "garaje89-inventario.firebasestorage.app",
        messagingSenderId: "538336429741",
        appId: "1:538336429741:web:0f7ce96f624f3568a8e824"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let usuarioActual = null, carrito = [], inventarioCache = [];

    // --- CONECTOR API (FETCH) ---
    async function callAPI(action, payload = {}) {
        document.getElementById('loader').classList.remove('oculto');
        try {
            // Enviamos POST con 'no-cors' no funciona para leer respuesta, usamos fetch standard
            // Apps Script debe estar publicado como "Cualquiera" para evitar CORS preflight issues
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, ...payload })
            });
            const data = await res.json();
            document.getElementById('loader').classList.add('oculto');
            return data;
        } catch (e) {
            document.getElementById('loader').classList.add('oculto');
            console.error(e);
            return null;
        }
    }

    // --- INICIO ---
    window.onload = function() {
        const sel = document.getElementById('login-user');
        // Cargamos usuarios desde Firebase
        db.collection("usuarios").get().then(s => {
            sel.innerHTML = '<option value="">Seleccionar Usuario...</option>';
            s.forEach(d => {
                let data = d.data();
                let o = document.createElement('option');
                o.value = d.id; o.innerText = data.nombre;
                sel.appendChild(o);
            });
        }).catch(e => {
            console.error(e);
            sel.innerHTML = '<option>Error Firebase</option>';
        });
    };

    function login() {
        let u = document.getElementById('login-user').value;
        let p = document.getElementById('login-pass').value;
        if(!u || !p) return;
        
        db.collection("usuarios").doc(u).get().then(doc => {
            if(doc.exists && doc.data().contraseÃ±a === p) {
                usuarioActual = doc.data(); usuarioActual.id = doc.id;
                document.getElementById('login-overlay').classList.add('oculto');
                document.getElementById('app-container').classList.remove('oculto');
                document.getElementById('user-display').innerText = usuarioActual.nombre;
                if(usuarioActual.permisos.rol !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('oculto'));
                cargarProvModal(); // Pre-cargar proveedores del Sheet
            } else {
                document.getElementById('login-error').innerText = "ContraseÃ±a Incorrecta";
            }
        });
    }

    function nav(id, el) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('oculto'));
        document.getElementById('sec-'+id).classList.remove('oculto');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        
        if(id==='pos') document.getElementById('scanner').focus();
        if(id==='entrada') document.getElementById('scanner-entrada').focus();
        if(id==='inv') cargarInv();
        if(id==='ventas') cargarVentas();
        if(id==='dash') cargarDash();
    }

    // --- POS (VENTA) ---
    document.getElementById('scanner').addEventListener('keypress', async function(e){
        if(e.key==='Enter'){
            let c = this.value; this.value='';
            const r = await callAPI('escanear', { codigo: c });
            if(r && r.status==='encontrado') addCar(r.producto);
            else alert("Producto no existe en inventario.");
        }
    });

    function addCar(p){
        let ex = carrito.find(x=>x.codigo===p.codigo);
        if(ex) ex.cantidad++; else carrito.push({...p, cantidad:1, precio:Number(p.precio)});
        renderCar();
    }
    function renderCar(){
        let h='', t=0;
        carrito.forEach((p,i)=>{
            t+=p.cantidad*p.precio;
            h+=`<tr><td>${p.nombre}</td><td>${p.cantidad}</td><td>S/ ${p.precio}</td><td>S/ ${(p.cantidad*p.precio).toFixed(2)}</td><td><button class="btn-neon" style="background:red; padding:5px" onclick="del(${i})"><i class="bi bi-trash"></i></button></td></tr>`;
        });
        document.getElementById('cart-body').innerHTML=h;
        document.getElementById('total-lbl').innerText=t.toFixed(2);
    }
    function del(i){ carrito.splice(i,1); renderCar(); }
    async function finalizar(t){
        if(carrito.length===0) return;
        if(t==='venta'){
            if(!confirm("Â¿Procesar venta?")) return;
            await callAPI('venta', {vendedor:usuarioActual.nombre, items:carrito});
            window.print(); carrito=[]; renderCar();
        } else window.print();
    }

    // --- ENTRADAS (STOCK +1) ---
    document.getElementById('scanner-entrada').addEventListener('keypress', async function(e){
        if(e.key==='Enter'){
            let c = this.value; this.value='';
            document.getElementById('msg-entrada').innerText = "Buscando...";
            const r = await callAPI('entradaStock', {codigo:c});
            if(r.status==='actualizado'){
                document.getElementById('msg-entrada').innerText = "âœ… " + r.producto.nombre + " (Stock: " + r.producto.nuevo_stock + ")";
                document.getElementById('msg-entrada').style.color = "var(--neon)";
            } else {
                document.getElementById('msg-entrada').innerText = "Producto nuevo. Abriendo registro...";
                document.getElementById('msg-entrada').style.color = "yellow";
                modalNuevo(c);
            }
        }
    });

    // --- INVENTARIO ---
    async function cargarInv(){
        const d = await callAPI('leerInventario');
        if(d) { inventarioCache=d; filtrarInv(); cargarProvModal(); }
    }
    function filtrarInv(){
        let f = document.getElementById('filtro-prov').value;
        let h = '';
        inventarioCache.forEach(r=>{
            if(f==='TODOS' || r[2]===f) h+=`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[5]}</td><td>${r[4]}</td></tr>`;
        });
        document.getElementById('inv-body').innerHTML=h;
    }

    // --- MODAL ---
    function modalNuevo(c){ document.getElementById('modal-overlay').classList.remove('oculto'); document.getElementById('n-codigo').value=c||''; cargarProvModal(); }
    function cerrarModal(){ document.getElementById('modal-overlay').classList.add('oculto'); }
    
    async function cargarProvModal(){
        const l = await callAPI('leerProveedores');
        if(!l) return;
        let s = document.getElementById('filtro-prov'); s.innerHTML='<option value="TODOS">Todos</option>';
        let m = document.getElementById('n-prov'); m.innerHTML='<option value="">Seleccionar...</option><option value="OTRO">âž• Nuevo Proveedor</option>';
        l.forEach(p=>{ s.innerHTML+=`<option value="${p}">${p}</option>`; m.innerHTML+=`<option value="${p}">${p}</option>`; });
    }
    function checkOtro(s){
        if(s.value==='OTRO') { document.getElementById('n-prov-txt').classList.remove('oculto'); document.getElementById('n-prov-txt').focus(); }
        else document.getElementById('n-prov-txt').classList.add('oculto');
    }
    async function guardarNuevo(){
        let p = document.getElementById('n-prov').value;
        if(p==='OTRO') p = document.getElementById('n-prov-txt').value;
        if(!p) return alert("Falta proveedor");
        let f = { codigo:document.getElementById('n-codigo').value, nombre:document.getElementById('n-nombre').value, proveedor:p, costo:document.getElementById('n-costo').value, precio:document.getElementById('n-precio').value, stock:document.getElementById('n-stock').value };
        await callAPI('guardarProducto', {form:f});
        alert("Guardado"); cerrarModal();
        if(!document.getElementById('sec-entrada').classList.contains('oculto')) {
            document.getElementById('scanner-entrada').focus();
            document.getElementById('msg-entrada').innerText = "Listo. Siguiente...";
        } else cargarInv();
    }

    // --- ADMIN ---
    async function cargarVentas(){
        const d = await callAPI('leerVentas');
        let h='';
        d.forEach(r=>{ h+=`<tr><td>${new Date(r[1]).toLocaleDateString()}</td><td>${r[2]}</td><td>${r[4]}</td><td><input class="input-neon" style="width:80px; padding:5px" value="${r[7]}" onchange="editV('${r[0]}',this.value)"></td><td><button class="btn-neon" style="background:red; padding:5px" onclick="delV('${r[0]}')"><i class="bi bi-trash"></i></button></td></tr>`; });
        document.getElementById('ventas-body').innerHTML=h;
    }
    async function editV(id,v){ await callAPI('editarVenta', {id, total:v}); }
    async function delV(id){ if(confirm("Â¿Eliminar?")) { await callAPI('eliminarVenta', {id}); cargarVentas(); } }
    async function cargarDash(){
        const d = await callAPI('dashboard');
        document.getElementById('d-hist').innerText = d.totalHistorico.toFixed(2);
        document.getElementById('d-hoy').innerText = d.totalHoy.toFixed(2);
    }
    function crearUser(){
        let i=document.getElementById('u-id').value; let n=document.getElementById('u-nom').value; let p=document.getElementById('u-pass').value; let r=document.getElementById('u-rol').value;
        db.collection("usuarios").doc(i).set({nombre:n, contraseÃ±a:p, permisos:{rol:r}}).then(()=>alert("Creado"));
    }
</script>
</body>
</html>