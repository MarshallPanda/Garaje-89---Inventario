<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garaje '89 | Pro System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>

    <style>
        :root { 
            --neon: #39ff14; 
            --dark: #050505; 
            --panel: rgba(20, 20, 20, 0.95); 
            --border: rgba(57, 255, 20, 0.3);
        }
        
        body { 
            background-color: var(--dark); 
            color: #e0e0e0; 
            font-family: 'Segoe UI', sans-serif; 
            overflow-x: hidden; 
            margin: 0;
        }

        /* SCROLLBAR OCULTO */
        ::-webkit-scrollbar { display: none; }

        .oculto { display: none !important; }
        .text-neon { color: var(--neon) !important; text-shadow: 0 0 10px rgba(57,255,20,0.4); }
        
        /* PANELES DE VIDRIO */
        .glass-panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); 
            transition: 0.3s;
        }

        /* INPUTS Y BOTONES */
        .input-neon { 
            background: rgba(0,0,0,0.4); 
            border: 1px solid #444; 
            color: white; 
            padding: 12px 15px; 
            width: 100%; 
            border-radius: 6px; 
            outline: none; 
            transition: 0.3s;
        }
        .input-neon:focus { 
            border-color: var(--neon); 
            box-shadow: 0 0 10px rgba(57,255,20,0.2); 
        }
        
        .btn-neon { 
            background: var(--neon); 
            color: black; 
            font-weight: 800; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 6px; 
            width: 100%; 
            text-transform: uppercase; 
            cursor: pointer; 
            transition: 0.3s; 
            letter-spacing: 1px;
        }
        .btn-neon:hover { 
            box-shadow: 0 0 20px var(--neon); 
            transform: translateY(-2px); 
        }

        /* BARRA LATERAL (SIDEBAR) */
        .sidebar { 
            position: fixed; 
            height: 100vh; 
            width: 260px; 
            background: #0a0a0a; 
            border-right: 1px solid #222; 
            padding-top: 30px; 
            display: flex; 
            flex-direction: column; 
            z-index: 1000; 
        }
        .nav-item { 
            padding: 15px 25px; 
            color: #888; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            transition: 0.2s; 
            font-size: 1.1rem;
        }
        .nav-item:hover, .nav-item.active { 
            color: var(--neon); 
            background: rgba(57,255,20,0.05); 
            border-left: 4px solid var(--neon); 
        }
        .user-footer {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid #222;
            text-align: center;
        }
        
        .main-content { 
            margin-left: 260px; 
            padding: 30px; 
        }

        /* PESTAÑAS (TABS) */
        .nav-pills .nav-link { 
            color: #888; 
            border: 1px solid #333; 
            margin-right: 8px; 
            cursor: pointer; 
            border-radius: 6px;
        }
        .nav-pills .nav-link.active { 
            background-color: var(--neon); 
            color: black; 
            font-weight: bold; 
            border-color: var(--neon);
        }

        /* TABLAS PERSONALIZADAS */
        .table-custom { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0 8px; 
        }
        .table-custom th { 
            color: var(--neon); 
            border-bottom: 1px solid #333; 
            padding: 10px; 
            text-align: left; 
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .table-custom td { 
            background: rgba(255,255,255,0.03); 
            border: none; 
            padding: 12px; 
            color: #ddd; 
            vertical-align: middle;
        }
        .hover-row:hover td {
            background: rgba(57, 255, 20, 0.1);
            cursor: pointer;
        }
        
        /* MODAL (Login y Alertas) */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 5000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
    </style>
</head>
<body>

    <div id="login-screen" class="modal-overlay">
        <div class="glass-panel text-center" style="width: 450px; padding: 40px;">
            <h1 class="text-neon mb-2 fst-italic" style="letter-spacing: 2px;">GARAJE '89</h1>
            <p class="text-secondary small mb-5">SISTEMA DE CONTROL DE ACCESO</p>
            
            <div class="mb-4 text-start">
                <label class="text-secondary small mb-2">CLAVE DE ACCESO</label>
                <input id="login-pass" type="password" class="input-neon text-center fw-bold text-neon" 
                       style="font-size: 1.5rem; letter-spacing: 5px;" 
                       placeholder="•••••"
                       onkeydown="if(event.key==='Enter') loginSystem()">
            </div>
            
            <button onclick="loginSystem()" class="btn-neon">INGRESAR AL SISTEMA</button>
            <p id="login-msg" class="text-danger mt-3 small"></p>
        </div>
    </div>

    <div id="app-container" class="oculto">
        
        <div class="sidebar">
            <div class="text-center mb-5">
                <h3 class="text-neon fst-italic">GARAJE '89</h3>
                <small class="text-secondary" style="letter-spacing: 3px;">PRO SYSTEM</small>
            </div>
            
            <div class="nav-item active" onclick="nav('pos', this)">
                <i class="bi bi-cart2 fs-4"></i> <span>Punto de Venta</span>
            </div>
            <div class="nav-item" onclick="nav('proveedores', this)">
                <i class="bi bi-boxes fs-4"></i> <span>Inventario & Sync</span>
            </div>
            <div class="nav-item" onclick="nav('dash', this)">
                <i class="bi bi-bar-chart-fill fs-4"></i> <span>Reportes</span>
            </div>

            <div class="user-footer">
                <div class="mb-2"><i class="bi bi-person-circle fs-3 text-secondary"></i></div>
                <h6 class="text-white mb-0" id="user-name">Usuario</h6>
                <small class="text-neon" id="user-role">Rol</small>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger w-100 mt-3">SALIR</button>
            </div>
        </div>

        <div class="main-content">
            
            <div id="sec-pos">
                <h2 class="text-white mb-4">PUNTO DE VENTA</h2>
                <div class="row">
                    <div class="col-md-8">
                        <div class="glass-panel" style="min-height: 80vh;">
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-dark border-secondary text-neon"><i class="bi bi-search"></i></span>
                                <input id="buscador-pos" class="form-control bg-dark text-white border-secondary input-neon" 
                                       placeholder="Escanear código o buscar por nombre..." 
                                       onkeyup="filtrarPos()" autocomplete="off">
                            </div>
                            <div style="height: 65vh; overflow-y: auto; padding-right: 5px;">
                                <table class="table-custom">
                                    <thead>
                                        <tr>
                                            <th>CÓDIGO</th>
                                            <th>DESCRIPCIÓN</th>
                                            <th>PRECIO</th>
                                            <th class="text-center">STOCK</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-busqueda">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="glass-panel h-100 d-flex flex-column">
                            <h4 class="text-neon mb-3"><i class="bi bi-cart-check-fill"></i> TICKET ACTUAL</h4>
                            <div class="flex-grow-1 overflow-auto mb-3" style="border-bottom: 1px solid #333;">
                                <table class="table-custom">
                                    <tbody id="cart-body"></tbody>
                                </table>
                            </div>
                            
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-secondary">ITEMS</span>
                                    <span class="text-white fw-bold" id="items-count">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <span class="text-secondary fs-5">TOTAL</span>
                                    <h2 class="text-white m-0">S/ <span class="text-neon" id="total-lbl">0.00</span></h2>
                                </div>
                                <button onclick="finalizarVenta()" class="btn-neon py-3 fs-5">
                                    <i class="bi bi-cash-coin me-2"></i> COBRAR
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-proveedores" class="oculto">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-white">GESTIÓN DE INVENTARIO</h2>
                    <div class="d-flex gap-2">
                        <button onclick="syncToSheets()" class="btn btn-outline-success d-flex align-items-center gap-2">
                            <i class="bi bi-cloud-arrow-up-fill"></i> RESPALDAR (Web -> Excel)
                        </button>
                        <button onclick="syncFromSheets()" class="btn btn-outline-warning d-flex align-items-center gap-2">
                            <i class="bi bi-cloud-arrow-down-fill"></i> RESTAURAR (Excel -> Web)
                        </button>
                    </div>
                </div>

                <ul class="nav nav-pills mb-4">
                    <li class="nav-item"><a class="nav-link active" onclick="cambiarProv('Suzuki', this)">Suzuki</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('HJ', this)">HJ</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('CF', this)">CF (x85%)</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('Bajaj', this)">Bajaj (+5%)</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('Inventario26', this)">Inv. 26</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('Otros', this)">Otros</a></li>
                </ul>

                <div class="glass-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom border-secondary">
                        <div>
                            <h4 class="text-neon m-0" id="titulo-prov">SUZUKI</h4>
                            <small class="text-secondary">Lista Maestra de Productos</small>
                        </div>
                        <div class="d-flex gap-2 bg-dark p-2 rounded border border-secondary align-items-center">
                            <i class="bi bi-file-earmark-excel-fill text-success fs-4"></i>
                            <input type="file" id="file-upload" class="form-control form-control-sm bg-dark text-white border-0" accept=".xlsx, .pdf">
                            <button class="btn btn-light btn-sm fw-bold px-3" onclick="compararArchivoLocal()">
                                COMPARAR
                            </button>
                        </div>
                    </div>
                    
                    <div style="height: 55vh; overflow-y: auto;">
                        <table class="table-custom">
                            <thead>
                                <tr>
                                    <th>CÓDIGO</th>
                                    <th>DESCRIPCIÓN</th>
                                    <th>PRECIO VENTA</th>
                                    <th>STOCK</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-prov">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sec-dash" class="oculto">
                <h2 class="text-white mb-4">REPORTES DE VENTA</h2>
                
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="glass-panel text-center py-5">
                            <h6 class="text-secondary text-uppercase mb-3">Ventas del Día</h6>
                            <h1 class="text-neon display-3 fw-bold m-0">S/ <span id="d-hoy">0.00</span></h1>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="glass-panel text-center py-5">
                            <h6 class="text-secondary text-uppercase mb-3">Acumulado del Mes</h6>
                            <h1 class="text-white display-3 fw-bold m-0">S/ <span id="d-mes">0.00</span></h1>
                        </div>
                    </div>
                </div>

                <div class="glass-panel">
                    <h5 class="text-neon mb-3">HISTORIAL RECIENTE</h5>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table-custom">
                            <thead>
                                <tr>
                                    <th>FECHA</th>
                                    <th>VENDEDOR</th>
                                    <th>PRODUCTO</th>
                                    <th>TOTAL</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-ventas-hist">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-comp" class="modal-overlay oculto">
        <div class="glass-panel w-75 h-75 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> ACTUALIZACIÓN DETECTADA</h3>
                <button onclick="document.getElementById('modal-comp').classList.add('oculto')" class="btn btn-sm btn-outline-secondary">CERRAR</button>
            </div>
            
            <div class="alert alert-dark border-secondary d-flex justify-content-between align-items-center">
                <span>Proveedor: <b class="text-white fs-5 mx-2" id="mod-prov"></b></span>
                <span>Regla de Precio: <b class="text-neon fs-5 mx-2" id="mod-regla"></b></span>
            </div>

            <div class="flex-grow-1 overflow-auto mb-3">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>CÓDIGO</th>
                            <th>PRECIO ACTUAL (WEB)</th>
                            <th>NUEVO PRECIO (ARCHIVO)</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody id="body-comp"></tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-end gap-3 pt-3 border-top border-secondary">
                <button onclick="document.getElementById('modal-comp').classList.add('oculto')" class="btn btn-outline-light px-4">CANCELAR</button>
                <button onclick="aplicarCambiosFirebase()" class="btn-neon px-5 w-auto">CONFIRMAR CAMBIOS</button>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURACIÓN (Tus credenciales)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfQE70fjhK4ufnfOrYGZRARxNpWTrNWt3KBE-cD7t031bZyETi9sW0UEF_LuAV2g92/exec"; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyBzUErnjQEGE9-neDh5z6VJ_xNaHRmAkew",
            authDomain: "garaje89-inventario.firebaseapp.com",
            projectId: "garaje89-inventario",
            storageBucket: "garaje89-inventario.firebasestorage.app",
            messagingSenderId: "538336429741",
            appId: "1:538336429741:web:0f7ce96f624f3568a8e824"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables Globales
        let usuarioActual = null;
        let inventarioLocal = [];
        let carrito = [];
        let cambiosPendientes = [];
        let provActual = 'Suzuki';

        // --- VALIDAR SI YA HABÍA INICIADO SESIÓN ---
        window.onload = function() {
            const savedUser = localStorage.getItem('garaje_user');
            if(savedUser) {
                usuarioActual = JSON.parse(savedUser);
                ingresarApp();
            }
        };

        // --- SISTEMA DE LOGIN (SOLO CLAVE) ---
        async function loginSystem() {
            const pass = document.getElementById('login-pass').value.trim();
            const btn = document.querySelector('#login-screen button');
            const msg = document.getElementById('login-msg');

            if(!pass) return;

            btn.innerText = "VERIFICANDO...";
            btn.disabled = true;
            msg.innerText = "";

            try {
                // Buscamos en la colección 'usuarios' donde el campo 'contraseña' coincida
                const snapshot = await db.collection('usuarios').where('contraseña', '==', pass).get();

                if (snapshot.empty) {
                    throw new Error("Contraseña no válida");
                }

                // Obtenemos datos del usuario (Nombre y Rol)
                const data = snapshot.docs[0].data();
                usuarioActual = {
                    id: snapshot.docs[0].id,
                    nombre: data.nombre,
                    rol: data.permisos.rol
                };

                // Guardar sesión y entrar
                localStorage.setItem('garaje_user', JSON.stringify(usuarioActual));
                ingresarApp();

            } catch (error) {
                msg.innerText = error.message;
                btn.innerText = "INGRESAR AL SISTEMA";
                btn.disabled = false;
                document.getElementById('login-pass').value = '';
            }
        }

        function ingresarApp() {
            document.getElementById('login-screen').classList.add('oculto');
            document.getElementById('app-container').classList.remove('oculto');
            
            // Actualizar Sidebar con datos del usuario
            document.getElementById('user-name').innerText = usuarioActual.nombre.toUpperCase();
            document.getElementById('user-role').innerText = usuarioActual.rol.toUpperCase();
            
            iniciarEscuchas();
        }

        function logout() {
            localStorage.removeItem('garaje_user');
            location.reload();
        }

        // --- ESCUCHAS EN TIEMPO REAL (BASE DE DATOS) ---
        function iniciarEscuchas() {
            // Inventario
            db.collection("inventario").onSnapshot(snap => {
                inventarioLocal = [];
                snap.forEach(doc => inventarioLocal.push({ id: doc.id, ...doc.data() }));
                
                // Refrescar vistas si están activas
                if(!document.getElementById('sec-proveedores').classList.contains('oculto')) renderTablaProv();
                if(document.getElementById('buscador-pos').value) filtrarPos();
            });

            // Ventas (Dashboard)
            db.collection("ventas").orderBy("fecha", "desc").limit(50).onSnapshot(snap => {
                let hoy = 0, mes = 0;
                const dHoy = new Date().toDateString();
                const dMes = new Date().getMonth();
                
                const tb = document.getElementById('tabla-ventas-hist');
                tb.innerHTML = '';

                snap.forEach(doc => {
                    const v = doc.data();
                    const fecha = v.fecha.toDate();
                    
                    if(fecha.toDateString() === dHoy) hoy += v.total;
                    if(fecha.getMonth() === dMes) mes += v.total;

                    // Llenar tabla historial
                    tb.innerHTML += `
                        <tr>
                            <td class="text-secondary small">${fecha.toLocaleDateString()}</td>
                            <td>${v.vendedor}</td>
                            <td>${v.nombre}</td>
                            <td class="text-neon fw-bold">S/ ${v.total.toFixed(2)}</td>
                        </tr>
                    `;
                });

                document.getElementById('d-hoy').innerText = hoy.toFixed(2);
                document.getElementById('d-mes').innerText = mes.toFixed(2);
            });
        }

        // --- PUNTO DE VENTA (POS) ---
        function filtrarPos() {
            const txt = document.getElementById('buscador-pos').value.toLowerCase();
            const list = document.getElementById('lista-busqueda');
            list.innerHTML = '';

            if(txt.length < 1) return;

            // Filtro (máximo 20 resultados para no saturar)
            const matches = inventarioLocal.filter(p => 
                (p.codigo && p.codigo.toLowerCase().includes(txt)) || 
                (p.nombre && p.nombre.toLowerCase().includes(txt))
            ).slice(0, 20);

            matches.forEach(p => {
                const stockStyle = p.stock > 0 ? 'text-white' : 'text-danger fw-bold';
                list.innerHTML += `
                    <tr class="hover-row" onclick="addToCart('${p.id}')">
                        <td class="text-neon fw-bold">${p.codigo}</td>
                        <td>${p.nombre}</td>
                        <td class="text-end">S/ ${p.precio.toFixed(2)}</td>
                        <td class="text-center ${stockStyle}">${p.stock}</td>
                        <td class="text-end"><i class="bi bi-plus-circle text-neon"></i></td>
                    </tr>
                `;
            });
        }

        function addToCart(id) {
            const prod = inventarioLocal.find(x => x.id === id);
            
            // Validación stock
            if(prod.stock <= 0) {
                if(!confirm("⚠️ Producto sin stock (" + prod.stock + "). ¿Vender igual?")) return;
            }

            const existe = carrito.find(x => x.id === id);
            if(existe) {
                existe.cantidad++;
            } else {
                carrito.push({ ...prod, cantidad: 1 });
            }
            
            // Limpiar buscador para seguir escaneando
            document.getElementById('buscador-pos').value = '';
            document.getElementById('lista-busqueda').innerHTML = '';
            document.getElementById('buscador-pos').focus();
            
            renderCart();
        }

        function renderCart() {
            const tb = document.getElementById('cart-body');
            tb.innerHTML = '';
            let total = 0;
            let count = 0;

            carrito.forEach((item, index) => {
                const subtotal = item.cantidad * item.precio;
                total += subtotal;
                count += item.cantidad;

                tb.innerHTML += `
                    <tr>
                        <td>
                            <div class="text-white fw-bold">${item.nombre}</div>
                            <small class="text-secondary">${item.codigo}</small>
                        </td>
                        <td style="width: 120px;">
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary py-0" onclick="modCant(${index}, -1)">-</button>
                                <span class="fw-bold">${item.cantidad}</span>
                                <button class="btn btn-sm btn-outline-secondary py-0" onclick="modCant(${index}, 1)">+</button>
                            </div>
                        </td>
                        <td class="text-end text-neon">S/ ${subtotal.toFixed(2)}</td>
                        <td><i class="bi bi-trash3-fill text-danger" style="cursor: pointer;" onclick="modCant(${index}, -999)"></i></td>
                    </tr>
                `;
            });

            document.getElementById('total-lbl').innerText = total.toFixed(2);
            document.getElementById('items-count').innerText = count;
        }

        function modCant(index, delta) {
            carrito[index].cantidad += delta;
            if(carrito[index].cantidad <= 0) {
                carrito.splice(index, 1);
            }
            renderCart();
        }

        async function finalizarVenta() {
            if(carrito.length === 0) return alert("El carrito está vacío");
            if(!confirm("¿Confirmar venta y procesar cobro?")) return;

            const btn = document.querySelector('#sec-pos .btn-neon');
            const originalText = btn.innerHTML;
            btn.innerHTML = "PROCESANDO...";
            btn.disabled = true;

            try {
                const batch = db.batch();
                const idVenta = "V-" + Date.now();
                const fecha = new Date();

                carrito.forEach(item => {
                    // 1. Restar Stock
                    const refInv = db.collection("inventario").doc(item.id);
                    batch.update(refInv, { stock: Number(item.stock) - item.cantidad });

                    // 2. Guardar Venta
                    const refVenta = db.collection("ventas").doc();
                    batch.set(refVenta, {
                        idVenta: idVenta,
                        fecha: fecha,
                        vendedor: usuarioActual.nombre,
                        codigo: item.codigo,
                        nombre: item.nombre,
                        cantidad: item.cantidad,
                        precio: item.precio,
                        total: item.cantidad * item.precio,
                        proveedor: item.proveedor || "General"
                    });
                });

                await batch.commit();
                
                alert("✅ Venta realizada con éxito");
                carrito = [];
                renderCart();

            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- GESTIÓN DE PROVEEDORES ---
        function cambiarProv(nombre, el) {
            provActual = nombre;
            // Actualizar UI pestañas
            document.querySelectorAll('.nav-pills .nav-link').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
            
            document.getElementById('titulo-prov').innerText = nombre.toUpperCase();
            renderTablaProv();
        }

        function renderTablaProv() {
            const tb = document.getElementById('tabla-prov');
            tb.innerHTML = '';
            
            // Filtrar productos del proveedor actual
            const productos = inventarioLocal.filter(p => p.proveedor === provActual);

            if(productos.length === 0) {
                tb.innerHTML = '<tr><td colspan="4" class="text-center text-secondary py-5">No hay productos registrados para esta marca.</td></tr>';
                return;
            }

            productos.forEach(p => {
                tb.innerHTML += `
                    <tr>
                        <td class="text-neon">${p.codigo}</td>
                        <td>${p.nombre}</td>
                        <td>S/ ${p.precio.toFixed(2)}</td>
                        <td>${p.stock}</td>
                    </tr>
                `;
            });
        }

        // --- COMPARATIVA DE ARCHIVOS (LÓGICA +5% / x85%) ---
        async function compararArchivoLocal() {
            const fileInput = document.getElementById('file-upload');
            if(!fileInput.files.length) return alert("Selecciona un archivo Excel o PDF");
            
            const file = fileInput.files[0];
            let dataExterno = [];

            // Leer archivo
            if(file.name.endsWith('.xlsx')) {
                dataExterno = await leerExcel(file);
            } else if(file.name.endsWith('.pdf')) {
                dataExterno = await leerPDF(file);
            } else {
                return alert("Formato no soportado");
            }

            // Definir reglas según pestaña actual
            let factor = 1;
            let reglaTxt = "Precios Exactos";
            
            if(provActual === 'Bajaj') { factor = 1.05; reglaTxt = "Aumento +5%"; }
            else if(provActual === 'CF') { factor = 0.85; reglaTxt = "Descuento x85%"; }

            document.getElementById('mod-prov').innerText = provActual;
            document.getElementById('mod-regla').innerText = reglaTxt;

            // Comparar
            cambiosPendientes = [];
            const tb = document.getElementById('body-comp');
            tb.innerHTML = '';

            const misProductos = inventarioLocal.filter(p => p.proveedor === provActual);

            misProductos.forEach(web => {
                // Buscar coincidencia por código
                const nuevo = dataExterno.find(n => String(n.codigo).trim() === String(web.codigo).trim());
                
                if(nuevo) {
                    const precioCalc = parseFloat((nuevo.precio * factor).toFixed(2));
                    
                    if(precioCalc !== web.precio) {
                        cambiosPendientes.push({ id: web.id, nuevoPrecio: precioCalc });
                        
                        tb.innerHTML += `
                            <tr>
                                <td>${web.codigo}</td>
                                <td class="text-secondary">S/ ${web.precio}</td>
                                <td class="text-neon fw-bold">S/ ${precioCalc}</td>
                                <td><span class="badge bg-warning text-dark">ACTUALIZAR</span></td>
                            </tr>
                        `;
                    }
                }
            });

            if(cambiosPendientes.length > 0) {
                document.getElementById('modal-comp').classList.remove('oculto');
            } else {
                alert("El archivo no contiene cambios de precio necesarios.");
            }
        }

        async function aplicarCambiosFirebase() {
            if(!confirm("¿Actualizar precios en Base de Datos?")) return;
            
            const batch = db.batch();
            cambiosPendientes.forEach(c => {
                const ref = db.collection("inventario").doc(c.id);
                batch.update(ref, { precio: c.nuevoPrecio });
            });
            
            await batch.commit();
            alert("Precios actualizados correctamente");
            document.getElementById('modal-comp').classList.add('oculto');
        }

        // --- LECTORES DE ARCHIVOS ---
        function leerExcel(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    // Normalizar columnas
                    const data = json.map(row => {
                        const keys = Object.keys(row);
                        const kCod = keys.find(k => k.match(/COD/i) || k.match(/ART/i));
                        const kPre = keys.find(k => k.match(/PRECIO/i) || k.match(/UNIT/i));
                        if(kCod && kPre) return { codigo: String(row[kCod]), precio: Number(row[kPre]) };
                        return null;
                    }).filter(x => x);
                    resolve(data);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function leerPDF(file) {
            alert("⚠️ Lectura PDF experimental");
            const buffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(buffer).promise;
            let items = [];
            
            for(let i=1; i<=pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const strings = content.items.map(x => x.str);
                
                // Algoritmo simple: buscar numero decimal (precio) precedido por texto
                for(let j=0; j<strings.length; j++) {
                    if(/^[0-9]+(\.[0-9]{2})?$/.test(strings[j]) && j>0) {
                        items.push({ codigo: strings[j-1], precio: parseFloat(strings[j]) });
                    }
                }
            }
            return items;
        }

        // --- SINCRONIZACIÓN (WEB <-> EXCEL) ---
        async function syncToSheets() {
            if(!confirm("⚠️ ATENCIÓN:\nSe borrará el Excel en Google Sheets y se subirá lo que ves en pantalla.\n¿Continuar?")) return;
            try {
                await fetch(APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'backupToSheets', inventario: inventarioLocal }) 
                });
                alert("✅ Respaldo completado en Google Sheets");
            } catch(e) { alert("Error: " + e.message); }
        }

        async function syncFromSheets() {
            if(!confirm("⚠️ CUIDADO:\nSe borrarán los datos de la Web y se traerán los del Excel.\n¿Continuar?")) return;
            try {
                const res = await fetch(APPS_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'restoreFromSheets' }) 
                });
                const data = await res.json();
                
                // Actualización por lotes
                const batch = db.batch();
                data.inventario.forEach(p => {
                    // Buscar si existe para no duplicar
                    const existe = inventarioLocal.find(x => x.codigo === p.codigo);
                    const ref = existe ? db.collection("inventario").doc(existe.id) : db.collection("inventario").doc();
                    batch.set(ref, p, { merge: true });
                });
                await batch.commit();
                alert("✅ Web actualizada desde el Excel");
            } catch(e) { alert("Error: " + e.message); }
        }

        // --- NAVEGACIÓN ---
        function nav(id, element) {
            // Activar clase visual
            document.querySelectorAll('.sidebar .nav-item').forEach(e => e.classList.remove('active'));
            element.classList.add('active');
            
            // Ocultar/Mostrar secciones
            ['sec-pos', 'sec-proveedores', 'sec-dash'].forEach(sec => {
                document.getElementById(sec).classList.add('oculto');
            });
            document.getElementById('sec-' + id).classList.remove('oculto');

            // Acciones extra al cambiar
            if(id === 'proveedores') renderTablaProv();
        }
    </script>
</body>
</html>