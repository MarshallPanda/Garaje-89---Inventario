<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garaje '89 | Pro System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --neon: #39ff14; --dark: #050505; --panel: rgba(20, 20, 20, 0.95); }
        body { background-color: var(--dark); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        ::-webkit-scrollbar { display: none; }
        .oculto { display: none !important; }
        .text-neon { color: var(--neon) !important; text-shadow: 0 0 10px rgba(57,255,20,0.4); }
        
        /* Paneles de Vidrio */
        .glass-panel { background: var(--panel); border: 1px solid rgba(57,255,20,0.3); border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        
        /* Inputs y Botones */
        .input-neon { background: rgba(0,0,0,0.4); border: 1px solid #444; color: white; padding: 10px; width: 100%; border-radius: 6px; outline: none; transition: 0.3s; }
        .input-neon:focus { border-color: var(--neon); box-shadow: 0 0 8px rgba(57,255,20,0.2); }
        
        .btn-neon { background: var(--neon); color: black; font-weight: 800; border: none; padding: 10px 20px; border-radius: 6px; width: 100%; transition: 0.3s; text-transform: uppercase; }
        .btn-neon:hover { box-shadow: 0 0 20px var(--neon); transform: translateY(-2px); }

        /* SIDEBAR */
        .sidebar { position: fixed; height: 100vh; width: 260px; background: #0a0a0a; border-right: 1px solid #222; padding-top: 20px; display: flex; flex-direction: column; z-index: 1000; }
        .nav-item { padding: 15px 25px; color: #888; cursor: pointer; display: flex; gap: 15px; transition: 0.2s; align-items: center; }
        .nav-item:hover, .nav-item.active { color: var(--neon); background: rgba(57,255,20,0.05); border-left: 4px solid var(--neon); }
        .main-content { margin-left: 260px; padding: 20px; }
        
        /* TABS */
        .nav-pills .nav-link.active { background-color: var(--neon); color: black; font-weight: bold; }
        .nav-pills .nav-link { color: #888; border: 1px solid #333; margin-right: 5px; cursor: pointer; }

        /* TABLAS */
        .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
        .table-custom th { color: var(--neon); border-bottom: 1px solid #333; padding: 10px; text-align: left; }
        .table-custom td { background: rgba(255,255,255,0.03); border: none; padding: 10px; color: #ddd; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="login-screen" class="modal-overlay">
        <div class="glass-panel text-center" style="width: 400px;">
            <h1 class="text-neon mb-4 fst-italic">GARAJE '89</h1>
            <p class="text-secondary small mb-4">ACCESO AL SISTEMA</p>
            <div class="text-start mb-3">
                <label class="small text-secondary">Correo</label>
                <input id="email" class="input-neon" placeholder="admin@garaje89.com">
            </div>
            <div class="text-start mb-4">
                <label class="small text-secondary">Contraseña</label>
                <input id="password" type="password" class="input-neon" placeholder="••••••••">
            </div>
            <button onclick="loginFirebase()" class="btn-neon w-100">INGRESAR</button>
            <p id="error-msg" class="text-danger mt-3 small"></p>
        </div>
    </div>

    <div id="app-container" class="oculto">
        
        <div class="sidebar">
            <div class="text-center mb-5">
                <h3 class="text-neon fst-italic">GARAJE '89</h3>
                <small class="text-secondary">SISTEMA INTEGRAL</small>
            </div>
            
            <div class="nav-item active" onclick="nav('pos', this)">
                <i class="bi bi-cart2 fs-5"></i> <span>Vender</span>
            </div>
            <div class="nav-item" onclick="nav('proveedores', this)">
                <i class="bi bi-boxes fs-5"></i> <span>Inventario & Sync</span>
            </div>
            <div class="nav-item" onclick="nav('dash', this)">
                <i class="bi bi-bar-chart-fill fs-5"></i> <span>Reportes</span>
            </div>

            <div class="mt-auto p-3 text-center border-top border-dark">
                <div class="mb-2"><i class="bi bi-person-circle fs-4 text-secondary"></i></div>
                <small class="text-secondary d-block mb-2" id="user-display">Usuario</small>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger w-100">CERRAR SESIÓN</button>
            </div>
        </div>

        <div class="main-content">
            
            <div id="sec-pos">
                <h3 class="text-white mb-4">PUNTO DE VENTA</h3>
                
                <div class="row">
                    <div class="col-md-7">
                        <div class="glass-panel">
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-dark border-secondary text-neon"><i class="bi bi-search"></i></span>
                                <input id="buscador-pos" class="form-control bg-dark text-white border-secondary input-neon" placeholder="Escanear código o buscar..." onkeyup="filtrarPos()">
                            </div>
                            <div style="height: 60vh; overflow-y: auto;">
                                <table class="table-custom w-100">
                                    <thead>
                                        <tr><th>COD</th><th>PRODUCTO</th><th>PRECIO</th><th>STOCK</th><th></th></tr>
                                    </thead>
                                    <tbody id="lista-busqueda"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-5">
                        <div class="glass-panel h-100 d-flex flex-column">
                            <h5 class="text-neon mb-3"><i class="bi bi-cart-check"></i> CARRITO ACTUAL</h5>
                            <div class="flex-grow-1 overflow-auto mb-3">
                                <table class="table-custom w-100">
                                    <tbody id="cart-body"></tbody>
                                </table>
                            </div>
                            <div class="border-top border-secondary pt-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-secondary">TOTAL A PAGAR</span>
                                    <h2 class="text-white m-0">S/ <span class="text-neon" id="total-lbl">0.00</span></h2>
                                </div>
                                <button onclick="finalizarVenta()" class="btn-neon w-100 py-3 fs-5">
                                    <i class="bi bi-cash-coin me-2"></i> COBRAR
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-proveedores" class="oculto">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-white">GESTIÓN DE INVENTARIO</h3>
                    <div class="d-flex gap-2">
                        <button onclick="syncToSheets()" class="btn btn-sm btn-outline-success d-flex align-items-center gap-2">
                            <i class="bi bi-cloud-arrow-up-fill"></i> Web <i class="bi bi-arrow-right"></i> Excel (Respaldo)
                        </button>
                        <button onclick="syncFromSheets()" class="btn btn-sm btn-outline-warning d-flex align-items-center gap-2">
                            <i class="bi bi-cloud-arrow-down-fill"></i> Excel <i class="bi bi-arrow-right"></i> Web (Restaurar)
                        </button>
                    </div>
                </div>

                <ul class="nav nav-pills mb-3">
                    <li class="nav-item"><a class="nav-link active" onclick="cambiarProv('Suzuki', this)">Suzuki</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('HJ', this)">HJ</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('CF', this)">CF (x85%)</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('Bajaj', this)">Bajaj (+5%)</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('Inventario26', this)">Inv. 26</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="cambiarProv('Otros', this)">Otros</a></li>
                </ul>

                <div class="glass-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom border-secondary">
                        <div>
                            <h5 class="text-neon m-0" id="titulo-prov">Suzuki</h5>
                            <small class="text-secondary">Actualización masiva por archivo</small>
                        </div>
                        <div class="d-flex gap-2 bg-dark p-2 rounded border border-secondary">
                            <input type="file" id="file-upload" class="form-control form-control-sm bg-dark text-white border-0" accept=".xlsx, .pdf">
                            <button class="btn btn-light btn-sm fw-bold" onclick="compararArchivoLocal()">
                                <i class="bi bi-search"></i> COMPARAR
                            </button>
                        </div>
                    </div>
                    
                    <div style="height: 50vh; overflow-y: auto;">
                        <table class="table-custom w-100">
                            <thead>
                                <tr><th>CÓDIGO</th><th>DESCRIPCIÓN</th><th>PRECIO VENTA</th><th>STOCK</th></tr>
                            </thead>
                            <tbody id="tabla-prov"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sec-dash" class="oculto">
                <h3 class="text-white mb-4">REPORTES Y ESTADÍSTICAS</h3>
                
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="glass-panel text-center h-100 d-flex flex-column justify-content-center">
                            <h6 class="text-secondary">VENTAS HOY</h6>
                            <h1 class="text-neon display-4 fw-bold">S/ <span id="d-hoy">0.00</span></h1>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="glass-panel text-center h-100 d-flex flex-column justify-content-center">
                            <h6 class="text-secondary">VENTAS ESTE MES</h6>
                            <h1 class="text-white display-4 fw-bold">S/ <span id="d-mes">0.00</span></h1>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="glass-panel text-center h-100 d-flex flex-column justify-content-center">
                            <h6 class="text-secondary">TOTAL ITEMS VENDIDOS (MES)</h6>
                            <h1 class="text-info display-4 fw-bold" id="d-items">0</h1>
                        </div>
                    </div>
                </div>

                <div class="glass-panel">
                    <h5 class="text-neon mb-3">HISTORIAL RECIENTE</h5>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="table-custom w-100">
                            <thead><th>FECHA</th><th>VENDEDOR</th><th>PRODUCTO</th><th>TOTAL</th></thead>
                            <tbody id="tabla-ventas-hist"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-comp" class="modal-overlay oculto">
        <div class="glass-panel w-75 h-75 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> DETECTAR CAMBIOS DE PRECIO</h4>
                <button onclick="cerrarModal()" class="btn btn-sm btn-outline-light">X</button>
            </div>
            
            <div class="alert alert-dark border-secondary d-flex justify-content-between">
                <span>Proveedor: <b class="text-white" id="mod-prov"></b></span>
                <span>Regla Aplicada: <b class="text-neon" id="mod-regla"></b></span>
            </div>

            <div class="flex-grow-1 overflow-auto mb-3">
                <table class="table-custom w-100">
                    <thead>
                        <tr><th>CÓDIGO</th><th>PRECIO WEB (ACTUAL)</th><th>NUEVO PRECIO (ARCHIVO)</th><th>ACCIÓN</th></tr>
                    </thead>
                    <tbody id="body-comp"></tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-end gap-3 pt-3 border-top border-secondary">
                <button onclick="cerrarModal()" class="btn btn-outline-secondary px-4">CANCELAR</button>
                <button onclick="aplicarCambiosFirebase()" class="btn-neon px-4 w-auto">CONFIRMAR Y ACTUALIZAR BD</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN DEL SISTEMA
        // ==========================================
        
        // 1. URL DE GOOGLE APPS SCRIPT (BACKEND EXCEL)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfQE70fjhK4ufnfOrYGZRARxNpWTrNWt3KBE-cD7t031bZyETi9sW0UEF_LuAV2g92/exec"; 

        // 2. CONFIGURACIÓN DE FIREBASE (TUS CREDENCIALES)
        const firebaseConfig = {
            apiKey: "AIzaSyBzUErnjQEGE9-neDh5z6VJ_xNaHRmAkew",
            authDomain: "garaje89-inventario.firebaseapp.com",
            projectId: "garaje89-inventario",
            storageBucket: "garaje89-inventario.firebasestorage.app",
            messagingSenderId: "538336429741",
            appId: "1:538336429741:web:0f7ce96f624f3568a8e824"
        };

        // INICIALIZACIÓN
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // VARIABLES GLOBALES
        let inventarioLocal = []; // Copia rápida de datos
        let carrito = [];
        let cambiosPendientes = [];
        let provActual = 'Suzuki';

        // ==========================================
        // 1. SISTEMA DE LOGIN
        // ==========================================
        function loginFirebase() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            const btn = document.querySelector('#login-screen button');
            
            btn.innerText = "VERIFICANDO...";
            
            auth.signInWithEmailAndPassword(e, p)
                .catch(err => {
                    document.getElementById('error-msg').innerText = "Error: " + err.message;
                    btn.innerText = "INGRESAR";
                });
        }

        // MONITOR DE ESTADO DE SESIÓN
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-screen').classList.add('oculto');
                document.getElementById('app-container').classList.remove('oculto');
                document.getElementById('user-display').innerText = user.email;
                iniciarSistema();
            } else {
                document.getElementById('login-screen').classList.remove('oculto');
                document.getElementById('app-container').classList.add('oculto');
            }
        });

        function logout() { auth.signOut(); location.reload(); }

        // ==========================================
        // 2. CARGA DE DATOS EN TIEMPO REAL
        // ==========================================
        function iniciarSistema() {
            // Escuchar cambios en Inventario
            db.collection("inventario").onSnapshot(snap => {
                inventarioLocal = [];
                snap.forEach(doc => inventarioLocal.push({ id: doc.id, ...doc.data() }));
                
                // Si estamos en la vista de inventario, actualizar tabla
                if (!document.getElementById('sec-proveedores').classList.contains('oculto')) {
                    renderTablaProv();
                }
                // Si estamos en POS, refrescar búsqueda si hay algo escrito
                if (document.getElementById('buscador-pos').value) {
                    filtrarPos();
                }
            });

            // Escuchar cambios en Ventas (Dashboard)
            escucharVentas();
        }

        // ==========================================
        // 3. PUNTO DE VENTA (POS)
        // ==========================================
        function filtrarPos() {
            const txt = document.getElementById('buscador-pos').value.toLowerCase();
            const list = document.getElementById('lista-busqueda');
            list.innerHTML = '';
            
            if (txt.length < 1) return;

            // Filtra y muestra máximo 20 resultados para rapidez
            const resultados = inventarioLocal.filter(p => 
                (p.codigo && p.codigo.toLowerCase().includes(txt)) || 
                (p.nombre && p.nombre.toLowerCase().includes(txt))
            ).slice(0, 20);

            resultados.forEach(p => {
                const stockClass = p.stock > 0 ? 'text-white' : 'text-danger';
                list.innerHTML += `
                    <tr onclick="addCart('${p.id}')" style="cursor:pointer; transition:0.2s" class="hover-bg">
                        <td class="text-neon fw-bold">${p.codigo}</td>
                        <td>${p.nombre}</td>
                        <td class="text-end">S/ ${p.precio.toFixed(2)}</td>
                        <td class="${stockClass} text-center">${p.stock}</td>
                        <td class="text-end"><i class="bi bi-plus-circle text-neon"></i></td>
                    </tr>`;
            });
        }

        function addCart(id) {
            const p = inventarioLocal.find(x => x.id === id);
            
            if (p.stock <= 0 && !confirm("Este producto tiene Stock 0. ¿Agregar igual?")) return;

            const ex = carrito.find(x => x.id === id);
            if (ex) {
                ex.cantidad++;
            } else {
                carrito.push({ ...p, cantidad: 1 });
            }
            
            document.getElementById('buscador-pos').value = '';
            document.getElementById('lista-busqueda').innerHTML = '';
            document.getElementById('buscador-pos').focus(); // Mantener foco para seguir escaneando
            renderCart();
        }

        function renderCart() {
            const tb = document.getElementById('cart-body'); 
            tb.innerHTML = '';
            let tot = 0;
            
            carrito.forEach((p, i) => {
                const sub = p.cantidad * p.precio;
                tot += sub;
                tb.innerHTML += `
                    <tr>
                        <td>
                            <div class="fw-bold text-white">${p.nombre}</div>
                            <small class="text-secondary">${p.codigo}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="cambiarCant(${i}, -1)">-</button>
                                <span class="fw-bold">${p.cantidad}</span>
                                <button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="cambiarCant(${i}, 1)">+</button>
                            </div>
                        </td>
                        <td class="text-end text-neon">S/ ${sub.toFixed(2)}</td>
                        <td class="text-end"><i class="bi bi-trash3-fill text-danger" style="cursor:pointer" onclick="delItem(${i})"></i></td>
                    </tr>`;
            });
            document.getElementById('total-lbl').innerText = tot.toFixed(2);
        }

        function cambiarCant(idx, delta) {
            carrito[idx].cantidad += delta;
            if (carrito[idx].cantidad <= 0) carrito.splice(idx, 1);
            renderCart();
        }
        function delItem(idx) { carrito.splice(idx, 1); renderCart(); }

        async function finalizarVenta() {
            if (!carrito.length) return alert("El carrito está vacío.");
            if (!confirm("¿Confirmar venta y procesar cobro?")) return;

            const btn = document.querySelector('#sec-pos button.btn-neon');
            const originalTxt = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> PROCESANDO...';
            btn.disabled = true;

            try {
                const batch = db.batch();
                const ventaId = "V-" + Date.now().toString().slice(-8);
                const fecha = new Date();

                // Preparar operaciones en lote
                carrito.forEach(item => {
                    // 1. Restar Stock
                    const refInv = db.collection("inventario").doc(item.id);
                    // Aseguramos que stock es número
                    const nuevoStock = Number(item.stock) - item.cantidad;
                    batch.update(refInv, { stock: nuevoStock });

                    // 2. Crear registro de venta
                    const refVenta = db.collection("ventas").doc();
                    batch.set(refVenta, {
                        idVenta: ventaId,
                        fecha: fecha,
                        vendedor: auth.currentUser.email,
                        codigo: item.codigo,
                        nombre: item.nombre,
                        cantidad: item.cantidad,
                        precio: item.precio,
                        total: item.cantidad * item.precio,
                        proveedor: item.proveedor || "Desconocido"
                    });
                });

                await batch.commit();
                alert("✅ Venta registrada correctamente");
                carrito = [];
                renderCart();
            } catch (error) {
                alert("Error al procesar: " + error.message);
            } finally {
                btn.innerHTML = originalTxt;
                btn.disabled = false;
            }
        }

        // ==========================================
        // 4. GESTIÓN DE PROVEEDORES
        // ==========================================
        function cambiarProv(nombre, el) {
            provActual = nombre;
            document.querySelectorAll('.nav-pills .nav-link').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('titulo-prov').innerText = nombre;
            renderTablaProv();
        }

        function renderTablaProv() {
            const tb = document.getElementById('tabla-prov'); 
            tb.innerHTML = '';
            
            // Filtramos el inventario local por la marca seleccionada
            const filtrados = inventarioLocal.filter(p => p.proveedor === provActual);
            
            if(filtrados.length === 0) {
                tb.innerHTML = '<tr><td colspan="4" class="text-center text-secondary py-4">No hay productos de esta marca.</td></tr>';
                return;
            }

            filtrados.forEach(p => {
                tb.innerHTML += `
                    <tr>
                        <td class="text-neon">${p.codigo}</td>
                        <td>${p.nombre}</td>
                        <td>S/ ${p.precio.toFixed(2)}</td>
                        <td>${p.stock}</td>
                    </tr>`;
            });
        }

        // --- COMPARATIVA DE ARCHIVOS (LÓGICA +5% / x85%) ---
        async function compararArchivoLocal() {
            const file = document.getElementById('file-upload').files[0];
            if (!file) return alert("Por favor selecciona un archivo Excel (.xlsx) o PDF.");

            let datosArchivo = [];
            
            // Selector de lector según extensión
            if (file.name.endsWith('.xlsx')) {
                datosArchivo = await leerExcel(file);
            } else if (file.name.endsWith('.pdf')) {
                datosArchivo = await leerPDF(file);
            } else {
                return alert("Formato no soportado.");
            }

            // Configurar Reglas según pestaña
            let factor = 1; 
            let reglaTxt = "Precios Exactos";
            
            if (provActual === 'Bajaj') { factor = 1.05; reglaTxt = "Aumento +5%"; }
            else if (provActual === 'CF') { factor = 0.85; reglaTxt = "Descuento x85%"; }

            document.getElementById('mod-prov').innerText = provActual;
            document.getElementById('mod-regla').innerText = reglaTxt;

            cambiosPendientes = [];
            const tb = document.getElementById('body-comp'); 
            tb.innerHTML = '';
            
            // Filtrar productos de Firebase de ESTA marca
            const misProductos = inventarioLocal.filter(p => p.proveedor === provActual);
            
            let count = 0;
            misProductos.forEach(web => {
                // Buscamos coincidencia de código en el archivo subido
                // Normalizamos a string y quitamos espacios
                const nuevo = datosArchivo.find(n => String(n.codigo).trim() === String(web.codigo).trim());
                
                if (nuevo) {
                    // APLICAMOS LA MATEMÁTICA
                    const precioCalculado = parseFloat((nuevo.precio * factor).toFixed(2));
                    
                    // Solo si el precio es diferente
                    if (precioCalculado !== web.precio) {
                        count++;
                        cambiosPendientes.push({ id: web.id, nuevoPrecio: precioCalculado });
                        
                        tb.innerHTML += `
                            <tr>
                                <td>${web.codigo}</td>
                                <td class="text-secondary">S/ ${web.precio}</td>
                                <td class="text-neon fw-bold">S/ ${precioCalculado}</td>
                                <td><span class="badge bg-warning text-dark">ACTUALIZAR</span></td>
                            </tr>`;
                    }
                }
            });

            if (count > 0) {
                document.getElementById('modal-comp').classList.remove('oculto');
            } else {
                alert("El archivo no contiene cambios de precio para los productos existentes.");
            }
        }

        async function aplicarCambiosFirebase() {
            if (!confirm(`¿Estás seguro de actualizar ${cambiosPendientes.length} precios en la base de datos en vivo?`)) return;

            const btn = document.querySelector('#modal-comp .btn-neon');
            btn.innerText = "ACTUALIZANDO...";
            btn.disabled = true;

            const batch = db.batch();
            cambiosPendientes.forEach(c => {
                const ref = db.collection("inventario").doc(c.id);
                batch.update(ref, { precio: c.nuevoPrecio });
            });

            await batch.commit();
            
            alert("✅ Base de datos actualizada correctamente.");
            cerrarModal();
            btn.innerText = "CONFIRMAR Y ACTUALIZAR BD";
            btn.disabled = false;
        }

        function cerrarModal() { document.getElementById('modal-comp').classList.add('oculto'); }

        // --- LECTORES DE ARCHIVOS ---
        function leerExcel(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    // Normalización inteligente de columnas
                    const normalizado = json.map(row => {
                        const keys = Object.keys(row);
                        // Buscar columnas parecidas a 'CODIGO' y 'PRECIO'
                        const kCod = keys.find(k => k.toUpperCase().includes('COD') || k.toUpperCase().includes('ART'));
                        const kPre = keys.find(k => k.toUpperCase().includes('PRECIO') || k.toUpperCase().includes('P.UNIT') || k.toUpperCase().includes('COSTO'));
                        
                        if(kCod && kPre) {
                            return { codigo: String(row[kCod]), precio: Number(row[kPre]) };
                        }
                        return null;
                    }).filter(x => x); // Eliminar nulos
                    
                    resolve(normalizado);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function leerPDF(file) {
            // Nota: Leer PDF es complejo en el navegador. Esta es una aproximación básica.
            alert("⚠️ La lectura de PDF es experimental. Verifica bien los precios detectados.");
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let items = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const strings = content.items.map(item => item.str);
                
                // Algoritmo básico de proximidad: Busca numero decimal (precio) precedido por texto (código)
                for(let j=0; j<strings.length; j++) {
                    const s = strings[j];
                    // Regex para precio (ej: 120.50 o 1500)
                    if (/^[0-9]+(\.[0-9]{2})?$/.test(s) && j > 0) {
                        items.push({ codigo: strings[j-1], precio: parseFloat(s) });
                    }
                }
            }
            return items;
        }


        // ==========================================
        // 5. SINCRONIZACIÓN (WEB <-> GOOGLE SHEETS)
        // ==========================================
        async function syncToSheets() {
            if (!confirm("⚠️ ATENCIÓN:\nSe borrarán las hojas de Google Sheets y se copiará el inventario actual de esta web.\n¿Deseas continuar el respaldo?")) return;

            alert("Iniciando respaldo en la nube... Esto puede tardar unos segundos.");
            
            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'backupToSheets',
                        inventario: inventarioLocal
                    })
                });
                alert("✅ Respaldo completado exitosamente en Google Sheets.");
            } catch (e) {
                alert("Error en el respaldo: " + e.message);
            }
        }

        async function syncFromSheets() {
            if (!confirm("⚠️ PELIGRO:\nSe actualizarán los datos de la web usando la información del Excel.\n¿Estás seguro de restaurar?")) return;

            alert("Descargando datos de Google Sheets...");
            
            try {
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'restoreFromSheets' })
                });
                const data = await res.json();
                
                if (data.inventario && data.inventario.length > 0) {
                    alert(`Se descargaron ${data.inventario.length} productos. Actualizando Firebase...`);
                    
                    const batch = db.batch();
                    data.inventario.forEach(p => {
                        // Buscamos si ya existe el código para actualizar su ID, sino creamos nuevo
                        const existente = inventarioLocal.find(l => l.codigo === p.codigo);
                        const ref = existente ? db.collection("inventario").doc(existente.id) : db.collection("inventario").doc();
                        
                        batch.set(ref, p, { merge: true });
                    });
                    
                    await batch.commit();
                    alert("✅ Restauración completada. La web está sincronizada con el Excel.");
                } else {
                    alert("El Excel parece estar vacío o hubo un error al leer.");
                }
            } catch (e) {
                alert("Error en la restauración: " + e.message);
            }
        }

        // ==========================================
        // 6. DASHBOARD
        // ==========================================
        function escucharVentas() {
            db.collection("ventas").orderBy("fecha", "desc").limit(100).onSnapshot(snap => {
                let hoy = 0, mes = 0, itemsMes = 0;
                const dateHoy = new Date().toDateString();
                const mesActual = new Date().getMonth();
                
                const tbHist = document.getElementById('tabla-ventas-hist');
                tbHist.innerHTML = '';

                snap.forEach(doc => {
                    const v = doc.data();
                    const fechaObj = v.fecha.toDate(); // Convertir Timestamp Firebase a JS Date
                    
                    if (fechaObj.toDateString() === dateHoy) hoy += v.total;
                    if (fechaObj.getMonth() === mesActual) {
                        mes += v.total;
                        itemsMes += v.cantidad;
                    }

                    // Llenar tabla historial (solo los primeros 10)
                    if (tbHist.childElementCount < 10) {
                        tbHist.innerHTML += `
                            <tr>
                                <td class="small text-secondary">${fechaObj.toLocaleDateString()}</td>
                                <td>${v.vendedor.split('@')[0]}</td>
                                <td>${v.nombre} <span class="text-secondary">x${v.cantidad}</span></td>
                                <td class="text-neon">S/ ${v.total.toFixed(2)}</td>
                            </tr>`;
                    }
                });

                document.getElementById('d-hoy').innerText = hoy.toFixed(2);
                document.getElementById('d-mes').innerText = mes.toFixed(2);
                document.getElementById('d-items').innerText = itemsMes;
            });
        }

        // ==========================================
        // NAVEGACIÓN
        // ==========================================
        function nav(id, el) {
            document.querySelectorAll('.sidebar .nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            
            ['sec-pos', 'sec-proveedores', 'sec-dash'].forEach(sec => document.getElementById(sec).classList.add('oculto'));
            document.getElementById('sec-' + id).classList.remove('oculto');

            if (id === 'proveedores') renderTablaProv();
        }

    </script>
</body>
</html>