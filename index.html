<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garaje '89 | Pro System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --neon: #39ff14; --dark: #050505; --panel: rgba(20, 20, 20, 0.7); --border: rgba(57, 255, 20, 0.3); }
        
        body { 
            background-color: var(--dark); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; 
            overflow-x: hidden; margin:0; 
            background-image: radial-gradient(circle at 10% 20%, rgba(57, 255, 20, 0.05) 0%, transparent 20%);
        }
        
        .oculto { display: none !important; }
        .text-neon { color: var(--neon) !important; text-shadow: 0 0 10px rgba(57,255,20,0.4); }
        
        .glass-panel { 
            background: var(--panel); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 15px; padding: 25px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); margin-bottom: 20px; transition: 0.3s;
        }
        .glass-panel:hover { border-color: var(--border); }

        .input-neon { 
            background: rgba(0,0,0,0.4); border: 1px solid #444; color: white; padding: 10px 15px; 
            width: 100%; border-radius: 8px; outline: none; transition: 0.3s;
        }
        .input-neon:focus { border-color: var(--neon); box-shadow: 0 0 8px rgba(57,255,20,0.2); }
        
        .btn-neon { 
            background: var(--neon); color: black; font-weight: 800; border: none; padding: 10px 20px; 
            border-radius: 8px; width: 100%; text-transform: uppercase; cursor: pointer; transition: 0.3s; 
            box-shadow: 0 0 10px rgba(57,255,20,0.2);
        }
        .btn-neon:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--neon); }
        
        .btn-outline { 
            background: transparent; border: 1px solid var(--neon); color: var(--neon); 
            padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .btn-outline:hover { background: var(--neon); color: black; }

        .btn-warning-custom {
            background: #ffcc00; color: black; font-weight: bold; border:none; padding: 8px 15px; border-radius: 8px;
        }

        .sidebar { 
            position: fixed; height: 100vh; width: 260px; 
            background: rgba(5,5,5,0.95); border-right: 1px solid #222; 
            padding-top: 30px; z-index: 1000; display: flex; flex-direction: column;
        }
        .nav-container { flex-grow: 1; }
        .brand { font-size: 2rem; font-weight: 900; text-align: center; margin-bottom: 40px; letter-spacing: 3px; font-style: italic; }
        .nav-item { padding: 15px 25px; color: #888; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; font-size: 1.1rem; }
        .nav-item:hover, .nav-item.active { color: var(--neon); background: linear-gradient(90deg, rgba(57,255,20,0.1) 0%, transparent 100%); border-left: 4px solid var(--neon); }
        .user-footer { padding: 20px; background: rgba(0,0,0,0.2); border-top: 1px solid #222; text-align: center; }
        .user-name-box { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; margin: 0 auto; font-weight: bold; color: white; }
        .main-content { margin-left: 260px; padding: 40px; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast-msg {
            background: rgba(15, 15, 15, 0.95); border-left: 4px solid var(--neon); color: #fff;
            padding: 15px 25px; border-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out forwards; min-width: 280px;
        }
        .toast-msg.error { border-left-color: #ff3333; }
        .toast-msg.info { border-left-color: #33ccff; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 5000; 
            display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        /* Modal Grande para conflictos */
        .modal-lg-box { 
            background: #111; width: 800px; max-width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px; 
            border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 0 50px rgba(57,255,20,0.15); 
        }

        .table-custom { width: 100%; border-collapse: collapse; color: #ccc; }
        .table-custom th { text-align: left; padding: 15px; color: var(--neon); border-bottom: 1px solid #444; font-size: 0.9rem; text-transform: uppercase; }
        .table-custom td { padding: 15px; border-bottom: 1px solid #222; font-size: 0.95rem; }
        
        .user-card { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid transparent; }
        
        @media (max-width: 768px) {
            .sidebar { left: -260px; transition: 0.3s; }
            .sidebar.active { left: 0; }
            .main-content { margin-left: 0; padding: 20px; }
            #mobile-toggle { display: block !important; position: fixed; top: 15px; left: 15px; z-index: 2000; }
        }
        @media print { .sidebar, .no-print { display: none; } .main-content { margin: 0; padding: 0; } body { background: white; color: black; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="login-overlay" class="modal-overlay active" style="z-index: 9999;">
        <div class="modal-box text-center" style="width: 400px; padding: 40px; background: #111; border-radius: 15px; border: 1px solid var(--neon);">
            <h1 class="brand text-neon mb-0">GARAJE '89</h1>
            <p class="text-secondary small mb-4">ACCESO SEGURO</p>
            <div class="text-start mb-4">
                <label class="text-secondary small ms-1">Contrase√±a</label>
                <input type="password" id="login-pass" class="input-neon text-center" style="font-size: 1.5rem; letter-spacing: 5px;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter') login()">
            </div>
            <button onclick="login()" class="btn-neon">INGRESAR</button>
            <p id="login-error" class="text-danger small mt-3" style="min-height: 20px;"></p>
        </div>
    </div>

    <div id="modal-conflicto" class="modal-overlay">
        <div class="modal-lg-box">
            <h3 class="text-warning text-center mb-4"><i class="bi bi-exclamation-triangle-fill"></i> CONFLICTO DE INVENTARIOS DETECTADO</h3>
            <p class="text-secondary text-center">Se han encontrado diferencias entre la base de datos de Firebase y el respaldo de Google Sheets.</p>
            
            <div class="glass-panel p-0 mb-4" style="max-height: 400px; overflow-y: auto;">
                <table class="table-custom text-small">
                    <thead>
                        <th>Producto</th>
                        <th>Firebase (Actual)</th>
                        <th>Google Sheets (Respaldo)</th>
                    </thead>
                    <tbody id="lista-conflictos"></tbody>
                </table>
            </div>

            <h5 class="text-white text-center mb-3">¬øQu√© versi√≥n deseas conservar?</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <button onclick="resolverConflicto('FIREBASE')" class="btn btn-outline-light w-100 py-3" style="border: 1px solid #fff;">
                        <i class="bi bi-database-fill"></i> MANTENER FIREBASE<br>
                        <small class="text-secondary">Ignorar Google Sheets</small>
                    </button>
                </div>
                <div class="col-md-6">
                    <button onclick="resolverConflicto('SHEETS')" class="btn btn-warning-custom w-100 py-3">
                        <i class="bi bi-file-earmark-spreadsheet-fill"></i> USAR GOOGLE SHEETS<br>
                        <small>Sobrescribir Firebase con Sheets</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <button id="mobile-toggle" class="btn btn-dark border-secondary text-neon no-print" style="display:none;" onclick="toggleSidebar()"><i class="bi bi-list fs-4"></i></button>

    <div id="app-container" class="oculto">
        <div class="sidebar no-print" id="sidebar">
            <div class="brand text-neon">GARAJE '89</div>
            <div class="nav-container">
                <div class="nav-item active" onclick="nav('pos', this)"><i class="bi bi-cart2"></i> Vender</div>
                <div class="nav-item" onclick="nav('entrada', this)"><i class="bi bi-box-arrow-in-down"></i> Entradas</div>
                <div class="nav-item" onclick="nav('inv', this)"><i class="bi bi-boxes"></i> Inventario</div>
                <div class="admin-only">
                    <hr style="border-color:#333; margin:20px 25px; opacity:0.5">
                    <div class="nav-item" onclick="nav('dash', this)"><i class="bi bi-bar-chart-fill"></i> Dashboard</div>
                    <div class="nav-item" onclick="nav('ventas', this)"><i class="bi bi-receipt-cutoff"></i> Historial</div>
                </div>
            </div>
            <div class="user-footer">
                <div class="mb-2"><i class="bi bi-person-circle text-secondary" style="font-size: 1.5rem;"></i></div>
                <div id="user-display" class="user-name-box">Usuario</div>
                <button onclick="location.reload()" class="btn btn-sm text-secondary mt-1 hover-danger">Salir</button>
            </div>
        </div>

        <div class="main-content">
            
            <div id="sec-pos" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-white m-0">PUNTO DE VENTA</h3>
                    <div class="text-secondary small" id="date-display"></div>
                </div>
                <div class="glass-panel p-4">
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-neon"><i class="bi bi-upc-scan"></i></span>
                        <input id="scanner" class="form-control bg-dark text-white border-secondary" style="font-size: 1.2rem;" placeholder="Escanear producto..." autofocus>
                    </div>
                </div>
                <div class="glass-panel" style="min-height: 400px;">
                    <table class="table-custom">
                        <thead><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th><th></th></thead>
                        <tbody id="cart-body"></tbody>
                    </table>
                    <div class="d-flex justify-content-between align-items-end mt-5 pt-4 border-top border-secondary">
                        <button onclick="finalizar('cotizar')" class="btn-outline px-4"><i class="bi bi-file-earmark-pdf"></i> COTIZAR (PDF)</button>
                        <div class="text-end">
                            <h6 class="text-secondary mb-0">TOTAL A PAGAR</h6>
                            <h1 class="text-neon display-4 fw-bold m-0">S/ <span id="total-lbl">0.00</span></h1>
                            <button onclick="finalizar('venta')" class="btn-neon mt-3 px-5 py-3"><i class="bi bi-check-lg me-2"></i> COBRAR Y GENERAR PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-entrada" class="view-section oculto">
                <h3 class="text-white mb-4">ENTRADAS DE STOCK</h3>
                <div class="glass-panel text-center py-5 d-flex flex-column align-items-center justify-content-center" style="height: 60vh;">
                    <div style="font-size: 5rem; color: var(--neon); opacity: 0.8;"><i class="bi bi-box-seam"></i></div>
                    <h4 class="mt-4 mb-4 fw-light">Escanea para sumar <b class="text-neon">+1</b></h4>
                    <input id="scanner-entrada" class="input-neon text-center" style="max-width: 400px; font-size: 1.5rem;" placeholder="C√≥digo...">
                    <div id="msg-entrada" class="mt-4 text-secondary">Listo para escanear...</div>
                </div>
            </div>

            <div id="sec-inv" class="view-section oculto">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-white m-0">INVENTARIO</h3>
                    
                    <div class="d-flex gap-2">
                        <div class="btn-group">
                            <button class="btn btn-outline-success btn-sm text-neon border-neon" onclick="syncFirebaseToSheets()" title="Copiar inventario actual al Excel">
                                <i class="bi bi-cloud-upload"></i> Firebase <i class="bi bi-arrow-right"></i> Sheets
                            </button>
                            <button class="btn btn-outline-warning btn-sm text-warning border-warning" onclick="syncSheetsToFirebase()" title="Traer respaldo del Excel al sistema">
                                <i class="bi bi-cloud-download"></i> Sheets <i class="bi bi-arrow-right"></i> Firebase
                            </button>
                        </div>
                        <button class="btn-neon" style="width: auto;" onclick="modalNuevo('')"><i class="bi bi-plus-lg me-2"></i> NUEVO</button>
                    </div>
                </div>
                
                <div class="glass-panel">
                    <div class="d-flex gap-3 mb-4">
                        <input id="search-inv" class="input-neon" placeholder="üîç Buscar..." onkeyup="filtrarInv()">
                        <select id="filtro-prov" class="input-neon w-25" onchange="filtrarInv()"><option value="TODOS">Todos</option></select>
                    </div>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <table class="table-custom">
                            <thead style="position: sticky; top: 0; background: #151515;">
                                <th>C√≥digo</th><th>Producto</th><th>Proveedor</th><th>Stock</th><th>Precio</th>
                            </thead>
                            <tbody id="inv-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sec-dash" class="view-section oculto">
                <h3 class="text-white mb-4">ESTAD√çSTICAS</h3>
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="glass-panel p-3 d-flex align-items-center gap-3"><div class="bg-dark p-3 rounded text-neon fs-3"><i class="bi bi-cash-stack"></i></div><div><h6 class="text-secondary m-0">Ventas Totales</h6><h3 class="text-white m-0">S/ <span id="d-hist">0.00</span></h3></div></div></div>
                    <div class="col-md-4"><div class="glass-panel p-3 d-flex align-items-center gap-3"><div class="bg-dark p-3 rounded text-warning fs-3"><i class="bi bi-calendar-check"></i></div><div><h6 class="text-secondary m-0">Ventas Hoy</h6><h3 class="text-white m-0">S/ <span id="d-hoy">0.00</span></h3></div></div></div>
                </div>
                <div class="glass-panel"><canvas id="chartProds" style="height: 300px; width: 100%;"></canvas></div>
            </div>

            <div id="sec-ventas" class="view-section oculto">
                <h3 class="text-white m-0 mb-4">HISTORIAL</h3>
                <div class="glass-panel" style="max-height: 75vh; overflow-y: auto;">
                    <table class="table-custom"><tbody id="ventas-body"></tbody></table>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box" style="background: #111; padding: 30px; width: 400px; border-radius: 15px; border: 1px solid var(--neon);">
            <h5 class="text-neon text-center mb-4">NUEVO PRODUCTO</h5>
            <input id="n-codigo" class="input-neon mb-3" readonly style="background: #222; color: #666;">
            <input id="n-nombre" class="input-neon mb-3" placeholder="Nombre">
            <input id="n-prov" class="input-neon mb-3" placeholder="Proveedor" list="lista-provs"><datalist id="lista-provs"></datalist>
            <div class="d-flex gap-2 mb-3"><input id="n-costo" type="number" class="input-neon" placeholder="Costo"><input id="n-precio" type="number" class="input-neon" placeholder="Precio Venta"></div>
            <input id="n-stock" type="number" class="input-neon mb-4" value="1" placeholder="Stock">
            <div class="d-flex gap-2"><button class="btn-outline w-50" onclick="closeModal()">CANCELAR</button><button class="btn-neon w-50" onclick="guardarNuevo()">GUARDAR</button></div>
        </div>
    </div>

<script>
    // --- 1. CONFIGURACI√ìN ---
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbziis4eKt8Ocj7iNq1injeiOVqds1JNHnwZLcHvFx2c48bTj2wiiBbAZP9xhZ56fT6G/exec"; 

    const firebaseConfig = {
        apiKey: "AIzaSyBzUErnjQEGE9-neDh5z6VJ_xNaHRmAkew",
        authDomain: "garaje89-inventario.firebaseapp.com",
        projectId: "garaje89-inventario",
        storageBucket: "garaje89-inventario.firebasestorage.app",
        messagingSenderId: "538336429741",
        appId: "1:538336429741:web:0f7ce96f624f3568a8e824"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let usuarioActual = null;
    let carrito = [];
    let inventario = []; 
    let cambiosPendientes = [];

    // --- 2. UTILS ---
    function showToast(msg, tipo = 'success') {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast-msg ${tipo}`;
        t.innerHTML = `<span>${msg}</span>`;
        c.appendChild(t);
        setTimeout(() => t.remove(), 3500);
    }

    // --- 3. LOGIN CON COMPARATIVA AUTOM√ÅTICA ---
    function login() {
        const pass = document.getElementById('login-pass').value.trim();
        const err = document.getElementById('login-error');
        if(!pass) return;

        err.innerText = "Verificando...";
        db.collection("usuarios").where("contrase√±a", "==", pass).limit(1).get()
        .then(snap => {
            if(!snap.empty) {
                const doc = snap.docs[0];
                usuarioActual = doc.data(); usuarioActual.id = doc.id;
                
                document.getElementById('login-overlay').classList.remove('active');
                document.getElementById('app-container').classList.remove('oculto');
                document.getElementById('user-display').innerText = usuarioActual.nombre;
                
                if(usuarioActual.permisos.rol !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('oculto'));
                
                showToast(`Bienvenido, ${usuarioActual.nombre}`);
                document.getElementById('scanner').focus();
                
                // DISPARAR VERIFICACI√ìN DE INVENTARIO
                verificarConflictosAlInicio();
            } else {
                err.innerText = "Contrase√±a incorrecta";
            }
        }).catch(e => { console.error(e); err.innerText = "Error conexi√≥n"; });
    }

    // --- 4. LOGICA DE SINCRONIZACI√ìN Y CONFLICTOS ---
    
    async function verificarConflictosAlInicio() {
        showToast("Verificando integridad del inventario...", "info");
        try {
            // A. Traer datos
            const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "leerInventario" }) });
            const sheetsData = await res.json();
            
            const snap = await db.collection("inventario").get();
            const fireData = [];
            snap.forEach(doc => fireData.push({ ...doc.data(), fid: doc.id }));

            // B. Comparar
            cambiosPendientes = []; // Reiniciar
            const conflictos = [];
            
            // Revisar Sheets vs Firebase
            sheetsData.forEach(itemS => {
                const itemF = fireData.find(f => f.codigo === String(itemS.codigo));
                const stockS = Number(itemS.stock);
                const precioS = Number(itemS.precio);
                
                if (itemF) {
                    if (Number(itemF.stock) !== stockS || Number(itemF.precio) !== precioS) {
                        conflictos.push({ tipo: 'DIFERENCIA', codigo: itemS.codigo, nombre: itemS.nombre, fire: {stock: itemF.stock, precio: itemF.precio}, sheet: {stock: stockS, precio: precioS}, fid: itemF.fid, dataFull: itemS });
                    }
                } else {
                    conflictos.push({ tipo: 'FALTA_EN_FIREBASE', codigo: itemS.codigo, nombre: itemS.nombre, fire: "NO EXISTE", sheet: {stock: stockS}, dataFull: itemS });
                }
            });

            // Si hay conflictos, mostrar modal
            if (conflictos.length > 0) {
                mostrarModalConflictos(conflictos);
                cambiosPendientes = conflictos; // Guardar para usar en los botones
            } else {
                showToast("‚úÖ Inventarios Sincronizados Correctamente");
            }

        } catch (e) { console.error(e); showToast("Error al conectar con Sheets", "error"); }
    }

    function mostrarModalConflictos(lista) {
        const tbody = document.getElementById('lista-conflictos');
        tbody.innerHTML = '';
        lista.forEach(c => {
            let descF = c.fire === "NO EXISTE" ? "<span class='text-danger'>No existe</span>" : `Stk:${c.fire.stock} | $: ${c.fire.precio}`;
            let descS = `Stk:${c.sheet.stock} | $: ${c.sheet.precio}`;
            tbody.innerHTML += `
                <tr>
                    <td class="text-white">${c.nombre}<br><small class="text-secondary">${c.codigo}</small></td>
                    <td class="text-neon">${descF}</td>
                    <td class="text-warning">${descS}</td>
                </tr>
            `;
        });
        document.getElementById('modal-conflicto').classList.add('active');
    }

    function resolverConflicto(decision) {
        document.getElementById('modal-conflicto').classList.remove('active');
        if (decision === 'FIREBASE') {
            showToast("Se mantiene inventario de Firebase. (Sheets ignorado)", "info");
            // Opcional: Podr√≠as forzar un 'Firebase -> Sheets' aqu√≠ para igualarlos
        } else {
            // Aplicar cambios de Sheets a Firebase
            aplicarCambiosDesdeSheets(cambiosPendientes);
        }
    }

    function aplicarCambiosDesdeSheets(listaCambios) {
        const batch = db.batch();
        listaCambios.forEach(c => {
            if (c.tipo === 'FALTA_EN_FIREBASE') {
                const ref = db.collection("inventario").doc();
                batch.set(ref, { ...c.dataFull, costo: Number(c.dataFull.costo), precio: Number(c.dataFull.precio), stock: Number(c.dataFull.stock) });
            } else {
                const ref = db.collection("inventario").doc(c.fid);
                batch.update(ref, { precio: Number(c.dataFull.precio), stock: Number(c.dataFull.stock), nombre: c.dataFull.nombre });
            }
        });
        batch.commit().then(() => showToast("‚úÖ Firebase actualizado con datos de Google Sheets"));
    }

    // --- 5. FUNCIONES DE LOS BOTONES MANUALES ---

    // A. SHEETS -> FIREBASE (Pull)
    function syncSheetsToFirebase() {
        if(confirm("¬øEst√°s seguro? Esto sobrescribir√° los datos de Firebase con los de Google Sheets.")) {
            verificarConflictosAlInicio().then(() => {
                // Si tras verificar sale el modal, el usuario elegir√° 'USAR GOOGLE SHEETS'
            });
        }
    }

    // B. FIREBASE -> SHEETS (Push)
    async function syncFirebaseToSheets() {
        if(!confirm("¬øDeseas copiar TODO el inventario de Firebase a Google Sheets? Esto borrar√° el Excel y pegar√° los datos actuales.")) return;
        
        showToast("Enviando datos a Google Sheets...", "info");
        try {
            // Obtener todo firebase limpio
            const snap = await db.collection("inventario").get();
            const lista = [];
            snap.forEach(doc => lista.push(doc.data()));
            
            const res = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "sobreescribirInventario", lista: lista })
            });
            const data = await res.json();
            showToast("‚úÖ " + data.msg);
        } catch(e) { console.error(e); showToast("Error al subir a Sheets", "error"); }
    }

    // --- 6. GENERACI√ìN DE PDF ---
    function generarPDF(tipo, items, total, codigoUnico) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Encabezado
        doc.setFillColor(0, 0, 0); // Negro
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(57, 255, 20); // Neon
        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text("GARAJE '89", 105, 20, null, null, "center");
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.text("SISTEMA DE GESTI√ìN & REPUESTOS", 105, 28, null, null, "center");

        // Info Venta
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.text(`FECHA: ${new Date().toLocaleString()}`, 15, 50);
        doc.text(`C√ìDIGO: ${codigoUnico}`, 15, 56);
        doc.text(`VENDEDOR: ${usuarioActual.nombre}`, 15, 62);
        
        if(tipo === 'cotizar') {
            doc.setFontSize(16);
            doc.setTextColor(100, 100, 100);
            doc.text("COTIZACI√ìN", 195, 55, null, null, "right");
        } else {
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text("BOLETA DE VENTA", 195, 55, null, null, "right");
        }

        // Tabla
        const tableBody = items.map(item => [
            item.codigo,
            item.nombre,
            item.cantidad,
            `S/ ${item.precio.toFixed(2)}`,
            `S/ ${(item.cantidad * item.precio).toFixed(2)}`
        ]);

        doc.autoTable({
            startY: 70,
            head: [['COD', 'DESCRIPCION', 'CANT', 'P.UNIT', 'TOTAL']],
            body: tableBody,
            theme: 'grid',
            headStyles: { fillColor: [20, 20, 20], textColor: [57, 255, 20] },
            styles: { fontSize: 9 }
        });

        // Total
        let finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(`TOTAL A PAGAR: S/ ${total.toFixed(2)}`, 195, finalY, null, null, "right");

        // Footer
        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        doc.text("Gracias por su preferencia - No se aceptan devoluciones pasadas las 24hrs.", 105, 280, null, null, "center");

        // Descargar
        doc.save(`${codigoUnico}.pdf`);
    }

    // --- 7. L√ìGICA VENTA / POS ---
    function finalizar(tipo) {
        if(carrito.length === 0) return showToast("Carrito vac√≠o", "error");
        
        const codigoVenta = "V-" + Date.now().toString().slice(-6); // C√≥digo corto √∫nico
        const totalVenta = carrito.reduce((acc, i) => acc + (i.cantidad * i.precio), 0);

        if(tipo === 'cotizar') {
            generarPDF('cotizar', carrito, totalVenta, "COT-" + Date.now().toString().slice(-6));
            return;
        }
        
        if(confirm("¬øConfirmar Venta y Generar Boleta?")) {
            const batch = db.batch();
            const idVenta = Date.now(); // ID num√©rico para Sheets
            
            // Preparar datos para Sheets
            const itemsSheets = carrito.map(i => ({ codigo: i.codigo, nombre: i.nombre, cantidad: i.cantidad, precio: i.precio }));

            // Actualizar Firebase
            carrito.forEach(item => {
                const ventaRef = db.collection("ventas").doc();
                batch.set(ventaRef, { fecha: new Date(), vendedor: usuarioActual.nombre, codigo: item.codigo, nombre: item.nombre, cantidad: item.cantidad, total: item.cantidad * item.precio });
                
                const invItem = inventario.find(p => p.codigo === item.codigo);
                if(invItem && invItem.id) {
                    batch.update(db.collection("inventario").doc(invItem.id), { stock: Number(invItem.stock) - item.cantidad });
                }
            });

            batch.commit().then(() => {
                // Enviar a Sheets
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "venta", items: itemsSheets, vendedor: usuarioActual.nombre, idVenta: idVenta })
                });

                // Generar PDF
                generarPDF('venta', carrito, totalVenta, codigoVenta);
                
                showToast("‚úÖ Venta Exitosa");
                carrito = []; renderCart();
            }).catch(e => showToast("Error: "+e, "error"));
        }
    }

    // --- 8. RESTO DE FUNCIONES (CRUD, LISTENERS, ETC) ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function nav(id, el) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('oculto'));
        document.getElementById('sec-'+id).classList.remove('oculto');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('sidebar').classList.remove('active');
        if(id === 'pos') document.getElementById('scanner').focus();
    }
    
    // Listeners Firebase
    db.collection("inventario").onSnapshot(snap => {
        inventario = []; const tbody = document.getElementById('inv-body'); tbody.innerHTML = '';
        const dl = document.getElementById('lista-provs'); dl.innerHTML = '';
        snap.forEach(doc => {
            const p = doc.data(); p.id = doc.id; inventario.push(p);
            dl.innerHTML += `<option value="${p.proveedor}">`;
            tbody.innerHTML += `<tr><td class="small text-secondary">${p.codigo}</td><td class="text-white font-weight-bold">${p.nombre}</td><td>${p.proveedor}</td><td>${p.stock}</td><td class="text-neon">S/ ${p.precio}</td></tr>`;
        });
    });

    // POS Cart
    document.getElementById('scanner').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') {
            const cod = e.target.value.trim(); e.target.value = '';
            const p = inventario.find(i => i.codigo === cod);
            if(p) {
                const ex = carrito.find(i => i.codigo === p.codigo);
                if(ex) ex.cantidad++; else carrito.push({ ...p, cantidad: 1, precio: Number(p.precio) });
                renderCart();
            } else if(confirm("Producto no encontrado. ¬øRegistrar?")) openModal(cod);
        }
    });
    function renderCart() {
        const tb = document.getElementById('cart-body'); tb.innerHTML = ''; let t = 0;
        carrito.forEach((p,i) => { t+=p.cantidad*p.precio; tb.innerHTML += `<tr><td>${p.nombre}</td><td>${p.cantidad}</td><td>${p.precio}</td><td class="text-neon">${(p.cantidad*p.precio).toFixed(2)}</td><td><i class="bi bi-x text-danger" onclick="carrito.splice(${i},1);renderCart()"></i></td></tr>`; });
        document.getElementById('total-lbl').innerText = t.toFixed(2);
    }
    
    // Modal & Guardar
    function openModal(c){ document.getElementById('modal-overlay').classList.add('active'); document.getElementById('n-codigo').value=c||''; }
    function closeModal(){ document.getElementById('modal-overlay').classList.remove('active'); }
    function guardarNuevo() {
        const p = { codigo: document.getElementById('n-codigo').value, nombre: document.getElementById('n-nombre').value, proveedor: document.getElementById('n-prov').value, costo: Number(document.getElementById('n-costo').value), precio: Number(document.getElementById('n-precio').value), stock: Number(document.getElementById('n-stock').value) };
        if(!p.nombre || !p.precio) return showToast("Faltan datos", "error");
        db.collection("inventario").add(p).then(() => { closeModal(); showToast("Guardado"); });
    }
    
    function filtrarInv() {
        const txt = document.getElementById('search-inv').value.toLowerCase();
        const rows = document.getElementById('inv-body').getElementsByTagName('tr');
        for(let r of rows) r.style.display = r.innerText.toLowerCase().includes(txt) ? '' : 'none';
    }
</script>
</body>
</html>