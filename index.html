<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garaje '89 | Pro System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --neon: #39ff14; --dark: #050505; --panel: rgba(20, 20, 20, 0.95); --border: rgba(57, 255, 20, 0.3); }
        
        body { 
            background-color: var(--dark); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; 
            overflow-x: hidden; margin:0; 
            background-image: radial-gradient(circle at 10% 20%, rgba(57, 255, 20, 0.05) 0%, transparent 20%);
        }
        
        .oculto { display: none !important; }
        .text-neon { color: var(--neon) !important; text-shadow: 0 0 10px rgba(57,255,20,0.4); }
        
        /* PANELES */
        .glass-panel { 
            background: var(--panel); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); margin-bottom: 20px; transition: 0.3s;
        }
        .glass-panel:hover { border-color: var(--border); }

        /* INPUTS Y BOTONES */
        .input-neon { 
            background: rgba(0,0,0,0.4); border: 1px solid #444; color: white; padding: 10px 15px; 
            width: 100%; border-radius: 6px; outline: none; transition: 0.3s;
        }
        .input-neon:focus { border-color: var(--neon); box-shadow: 0 0 8px rgba(57,255,20,0.2); }
        
        .btn-neon { 
            background: var(--neon); color: black; font-weight: 800; border: none; padding: 12px 20px; 
            border-radius: 6px; width: 100%; text-transform: uppercase; cursor: pointer; transition: 0.3s; 
            box-shadow: 0 0 10px rgba(57,255,20,0.2);
        }
        .btn-neon:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--neon); }
        
        .btn-outline { 
            background: transparent; border: 1px solid var(--neon); color: var(--neon); 
            padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .btn-outline:hover { background: var(--neon); color: black; }

        /* SIDEBAR */
        .sidebar { 
            position: fixed; height: 100vh; width: 260px; 
            background: #0a0a0a; border-right: 1px solid #222; 
            padding-top: 20px; z-index: 2000; 
            display: flex; flex-direction: column;
            transition: transform 0.3s ease-in-out;
        }
        .nav-container { flex-grow: 1; overflow-y: auto; }
        
        .brand { font-size: 1.8rem; font-weight: 900; text-align: center; margin-bottom: 30px; letter-spacing: 2px; font-style: italic; }
        .nav-item { padding: 15px 25px; color: #888; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; font-size: 1rem; }
        .nav-item:hover, .nav-item.active { color: var(--neon); background: rgba(57,255,20,0.05); border-left: 4px solid var(--neon); }
        
        .user-footer { padding: 20px; background: #000; border-top: 1px solid #222; text-align: center; }
        .user-name-box { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; margin: 0 auto; font-weight: bold; color: white; }

        .main-content { margin-left: 260px; padding: 20px; transition: 0.3s; }

        /* NOTIFICACIONES TOAST */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast-msg {
            background: #111; border-left: 4px solid var(--neon); color: #fff;
            padding: 15px 20px; border-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out forwards;
            min-width: 280px; font-size: 0.9rem; border: 1px solid #333;
        }
        .toast-msg.error { border-left-color: #ff3333; }
        .toast-msg.info { border-left-color: #33ccff; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* MODALES */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 5000; 
            display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-box { 
            background: #111; width: 400px; max-width: 90%; padding: 30px; border-radius: 12px; 
            border: 1px solid var(--border); box-shadow: 0 0 50px rgba(57,255,20,0.1); 
        }
        .modal-lg-box { width: 800px; max-width: 95%; max-height: 90vh; overflow-y: auto; }

        /* TABLAS */
        .table-responsive-custom { overflow-x: auto; }
        .table-custom { width: 100%; border-collapse: collapse; color: #ccc; min-width: 600px; }
        .table-custom th { text-align: left; padding: 12px; color: var(--neon); border-bottom: 1px solid #444; font-size: 0.85rem; text-transform: uppercase; }
        .table-custom td { padding: 12px; border-bottom: 1px solid #222; font-size: 0.9rem; }
        
        .user-card { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            #mobile-toggle { display: block !important; position: fixed; top: 15px; left: 15px; z-index: 3000; background: #000; border: 1px solid var(--neon); color: var(--neon); border-radius: 4px; padding: 5px 10px; }
            .glass-panel { padding: 15px; }
            .btn-group-sync { flex-direction: column; width: 100%; }
            .btn-group-sync button, .btn-group-sync a { width: 100%; margin-bottom: 5px; }
        }
        @media print { .sidebar, .no-print, #mobile-toggle { display: none; } .main-content { margin: 0; padding: 0; } body { background: white; color: black; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    <button id="mobile-toggle" style="display:none;" onclick="toggleSidebar()"><i class="bi bi-list fs-4"></i></button>

    <div id="login-overlay" class="modal-overlay active" style="z-index: 9999;">
        <div class="modal-box text-center">
            <h1 class="brand text-neon mb-0">GARAJE '89</h1>
            <p class="text-secondary small mb-4">ACCESO AL SISTEMA</p>
            <div class="text-start mb-4">
                <label class="text-secondary small ms-1">Contraseña</label>
                <input type="password" id="login-pass" class="input-neon text-center" style="font-size: 1.5rem; letter-spacing: 5px;" placeholder="••••••" onkeydown="if(event.key==='Enter') login()">
            </div>
            <button onclick="login()" class="btn-neon">INGRESAR</button>
            <p id="login-error" class="text-danger small mt-3"></p>
        </div>
    </div>

    <div id="modal-conflicto" class="modal-overlay">
        <div class="modal-box modal-lg-box p-4">
            <h4 class="text-warning text-center mb-4"><i class="bi bi-exclamation-triangle-fill"></i> CONFLICTO DE DATOS</h4>
            <div class="glass-panel p-0 mb-4" style="max-height: 300px; overflow-y: auto;">
                <table class="table-custom"><thead><th>Producto</th><th>Firebase</th><th>Sheets</th></thead><tbody id="lista-conflictos"></tbody></table>
            </div>
            <div class="row g-2">
                <div class="col-6"><button onclick="resolverConflicto('FIREBASE')" class="btn btn-outline-light w-100">MANTENER FIREBASE</button></div>
                <div class="col-6"><button onclick="resolverConflicto('SHEETS')" class="btn btn-warning w-100 fw-bold">USAR SHEETS</button></div>
            </div>
        </div>
    </div>

    <div id="app-container" class="oculto">
        <div class="sidebar no-print" id="sidebar">
            <div class="brand text-neon">GARAJE '89</div>
            <div class="nav-container">
                <div class="nav-item active" onclick="nav('pos', this)"><i class="bi bi-cart2"></i> Vender</div>
                <div class="nav-item" onclick="nav('entrada', this)"><i class="bi bi-box-arrow-in-down"></i> Entradas</div>
                <div class="nav-item" onclick="nav('inv', this)"><i class="bi bi-boxes"></i> Inventario</div>
                <div class="admin-only">
                    <hr style="border-color:#333; margin:20px 25px; opacity:0.5">
                    <div class="nav-item" onclick="nav('dash', this)"><i class="bi bi-bar-chart-fill"></i> Dashboard</div>
                    <div class="nav-item" onclick="nav('ventas', this)"><i class="bi bi-receipt-cutoff"></i> Historial</div>
                    <div class="nav-item" onclick="nav('users', this)"><i class="bi bi-people-fill"></i> Usuarios</div>
                </div>
            </div>
            <div class="user-footer">
                <div class="mb-2"><i class="bi bi-person-circle text-secondary" style="font-size: 1.5rem;"></i></div>
                <div id="user-display" class="user-name-box">Usuario</div>
                <button onclick="location.reload()" class="btn btn-sm text-secondary mt-1 hover-danger">Salir</button>
            </div>
        </div>

        <div class="main-content">
            <div id="sec-pos" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-white m-0">PUNTO DE VENTA</h3>
                    <div class="text-secondary small" id="date-display"></div>
                </div>
                <div class="glass-panel p-3">
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-neon"><i class="bi bi-upc-scan"></i></span>
                        <input id="scanner" class="form-control bg-dark text-white border-secondary" style="font-size: 1.2rem;" placeholder="Escanear..." autocomplete="off">
                        <button class="btn btn-outline-secondary border-secondary text-white" onclick="procesarScanPos()"><i class="bi bi-arrow-return-left"></i></button>
                    </div>
                </div>
                <div class="glass-panel" style="min-height: 400px;">
                    <div class="table-responsive-custom"><table class="table-custom"><thead><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th><th></th></thead><tbody id="cart-body"></tbody></table></div>
                    <div class="mt-4 pt-4 border-top border-secondary">
                        <div class="d-flex justify-content-between align-items-center mb-3"><span class="text-secondary">Total:</span><h2 class="text-neon m-0">S/ <span id="total-lbl">0.00</span></h2></div>
                        <div class="d-flex gap-2 justify-content-end">
                            <button onclick="finalizar('cotizar')" class="btn-outline px-4"><i class="bi bi-file-earmark-pdf"></i> COTIZAR</button>
                            <button onclick="finalizar('venta')" class="btn-neon px-4"><i class="bi bi-check-lg"></i> COBRAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-entrada" class="view-section oculto">
                <h3 class="text-white mb-4">ENTRADAS</h3>
                <div class="glass-panel text-center py-5 d-flex flex-column align-items-center justify-content-center" style="min-height: 60vh;">
                    <div style="font-size: 4rem; color: var(--neon); opacity: 0.8;"><i class="bi bi-box-seam"></i></div>
                    <h4 class="mt-4 mb-4 fw-light">Escanear para sumar <b class="text-neon">+1</b></h4>
                    <div class="d-flex justify-content-center gap-2 w-100" style="max-width: 400px;">
                        <input id="scanner-entrada" class="input-neon text-center" style="font-size: 1.5rem;" placeholder="Código..." autocomplete="off">
                        <button class="btn btn-outline-secondary border-secondary text-neon" onclick="procesarScanEntrada()"><i class="bi bi-arrow-return-left"></i></button>
                    </div>
                    <div id="msg-entrada" class="mt-4 text-secondary fs-5">Listo para escanear...</div>
                </div>
            </div>

            <div id="sec-inv" class="view-section oculto">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                    <h3 class="text-white m-0">INVENTARIO</h3>
                    <div class="d-flex gap-2 btn-group-sync">
                        <a href="https://docs.google.com/spreadsheets/d/1sBeK5DD8nM9Ys02O28VoRi7wTS3k8VUA0GimYxw0Pdo/edit?usp=sharing" target="_blank" class="btn btn-success btn-sm fw-bold text-white text-decoration-none d-flex align-items-center justify-content-center"><i class="bi bi-file-earmark-spreadsheet-fill me-2"></i> VER EXCEL</a>
                        <button class="btn btn-outline-success btn-sm text-neon border-neon" onclick="syncFirebaseToSheets()"><i class="bi bi-cloud-upload"></i> A Sheets</button>
                        <button class="btn btn-outline-warning btn-sm text-warning border-warning" onclick="syncSheetsToFirebase()"><i class="bi bi-cloud-download"></i> De Sheets</button>
                        <button class="btn-neon btn-sm" style="width: auto;" onclick="modalNuevo('')"><i class="bi bi-plus-lg"></i> NUEVO</button>
                    </div>
                </div>
                <div class="glass-panel">
                    <div class="d-flex flex-column flex-md-row gap-3 mb-4">
                        <input id="search-inv" class="input-neon" placeholder="Buscar..." onkeyup="filtrarInv()">
                        <select id="filtro-prov" class="input-neon w-100 w-md-25" onchange="filtrarInv()"><option value="TODOS">Todos</option></select>
                    </div>
                    <div style="max-height: 60vh; overflow-y: auto;" class="table-responsive-custom">
                        <table class="table-custom">
                            <thead><th>Código</th><th>Producto</th><th>Proveedor</th><th>Stock</th><th>Precio</th><th></th></thead>
                            <tbody id="inv-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sec-dash" class="view-section oculto">
                <h3 class="text-white mb-4">ESTADÍSTICAS Y REPORTES</h3>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="glass-panel p-3 d-flex align-items-center gap-3"><div class="bg-dark p-3 rounded text-neon fs-3"><i class="bi bi-cash-stack"></i></div><div><h6 class="text-secondary m-0">Total Histórico</h6><h4 class="text-white m-0">S/ <span id="d-hist">0.00</span></h4></div></div></div>
                    <div class="col-md-4"><div class="glass-panel p-3 d-flex align-items-center gap-3"><div class="bg-dark p-3 rounded text-warning fs-3"><i class="bi bi-calendar-check"></i></div><div><h6 class="text-secondary m-0">Ventas Hoy</h6><h4 class="text-white m-0">S/ <span id="d-hoy">0.00</span></h4></div></div></div>
                    <div class="col-md-4"><div class="glass-panel p-3 d-flex align-items-center gap-3"><div class="bg-dark p-3 rounded text-info fs-3"><i class="bi bi-box"></i></div><div><h6 class="text-secondary m-0">Productos Hoy</h6><h4 class="text-white m-0" id="d-count">0</h4></div></div></div>
                </div>

                <div class="glass-panel mb-4">
                    <h5 class="text-neon mb-3"><i class="bi bi-filter-circle"></i> Reporte por Periodo</h5>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="text-secondary small">Desde</label>
                            <input type="date" id="dash-desde" class="input-neon">
                        </div>
                        <div class="col-md-4">
                            <label class="text-secondary small">Hasta</label>
                            <input type="date" id="dash-hasta" class="input-neon">
                        </div>
                        <div class="col-md-4">
                            <button onclick="generarReporte()" class="btn-neon"><i class="bi bi-search"></i> FILTRAR REPORTE</button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="glass-panel">
                            <h5 class="text-white mb-3">Ventas del Periodo</h5>
                            <div style="max-height: 300px; overflow-y: auto;" class="table-responsive-custom">
                                <table class="table-custom">
                                    <thead><th>Fecha</th><th>Producto</th><th>Cant</th><th>Total</th></thead>
                                    <tbody id="dash-report-body"><tr><td colspan="4" class="text-center text-secondary">Selecciona fechas y filtra...</td></tr></tbody>
                                </table>
                            </div>
                            <h5 class="text-end mt-3 text-neon">Total Periodo: S/ <span id="dash-periodo-total">0.00</span></h5>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="glass-panel">
                            <h5 class="text-white mb-3">Top Productos (Periodo)</h5>
                            <canvas id="chartProds" style="height: 250px; width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-ventas" class="view-section oculto">
                <h3 class="text-white m-0 mb-4">HISTORIAL RECIENTE</h3>
                <div class="glass-panel table-responsive-custom" style="max-height: 75vh; overflow-y: auto;">
                    <table class="table-custom">
                        <thead><th>Fecha</th><th>Vendedor</th><th>Producto</th><th>Total</th><th></th></thead>
                        <tbody id="ventas-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-users" class="view-section oculto">
                <h3 class="text-white mb-4">USUARIOS</h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="glass-panel">
                            <h5 class="text-neon mb-3">Crear Usuario</h5>
                            <input id="u-id" class="input-neon mb-2" placeholder="ID">
                            <input id="u-nom" class="input-neon mb-2" placeholder="Nombre">
                            <input id="u-pass" class="input-neon mb-2" type="password" placeholder="Pass">
                            <select id="u-rol" class="input-neon mb-3"><option value="trabajador">Trabajador</option><option value="admin">Admin</option></select>
                            <button class="btn-neon" onclick="crearUser()">Guardar</button>
                        </div>
                    </div>
                    <div class="col-md-8"><div class="glass-panel"><div id="users-list"></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <h5 class="text-neon text-center mb-4" id="modal-titulo">PRODUCTO</h5>
            <input id="n-id-edit" type="hidden"> <input id="n-codigo" class="input-neon mb-3" readonly style="background: #222; color: #666;">
            <input id="n-nombre" class="input-neon mb-3" placeholder="Nombre">
            <input id="n-prov" class="input-neon mb-3" placeholder="Proveedor" list="lista-provs"><datalist id="lista-provs"></datalist>
            <div class="d-flex gap-2 mb-3">
                <input id="n-costo" type="number" class="input-neon" placeholder="Costo">
                <input id="n-precio" type="number" class="input-neon" placeholder="Precio">
            </div>
            <input id="n-stock" type="number" class="input-neon mb-4" placeholder="Stock">
            <div class="d-flex gap-2">
                <button class="btn-outline w-50" onclick="closeModal()">CANCELAR</button>
                <button class="btn-neon w-50" onclick="guardarProducto()">GUARDAR</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURACIÓN ---
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvoD4_lvCa-nrb5ijAYrcjKsHdETXRRwgouCfjE8Yi9e0BIhepZnC4E3N0pK6JyNo7/exec"; 
    const firebaseConfig = { apiKey: "AIzaSyBzUErnjQEGE9-neDh5z6VJ_xNaHRmAkew", authDomain: "garaje89-inventario.firebaseapp.com", projectId: "garaje89-inventario", storageBucket: "garaje89-inventario.firebasestorage.app", messagingSenderId: "538336429741", appId: "1:538336429741:web:0f7ce96f624f3568a8e824" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let usuarioActual = null, carrito = [], inventario = [], cambiosPendientes = [];

    // --- UTILS ---
    function showToast(msg, tipo = 'success') {
        const c = document.getElementById('toast-container'), t = document.createElement('div');
        t.className = `toast-msg ${tipo}`;
        let icon = tipo === 'error' ? '<i class="bi bi-exclamation-triangle-fill"></i>' : '<i class="bi bi-check-circle-fill"></i>';
        t.innerHTML = `${icon} <span>${msg}</span>`; c.appendChild(t); setTimeout(() => t.remove(), 3500);
    }

    // --- LOGIN ---
    function login() {
        const pass = document.getElementById('login-pass').value.trim();
        if(!pass) return;
        db.collection("usuarios").where("contraseña", "==", pass).limit(1).get().then(snap => {
            if(!snap.empty) {
                usuarioActual = snap.docs[0].data(); usuarioActual.id = snap.docs[0].id;
                document.getElementById('login-overlay').classList.remove('active');
                document.getElementById('app-container').classList.remove('oculto');
                document.getElementById('user-display').innerText = usuarioActual.nombre;
                document.getElementById('date-display').innerText = new Date().toLocaleDateString();
                if(usuarioActual.permisos.rol !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('oculto'));
                showToast(`Bienvenido ${usuarioActual.nombre}`);
                document.getElementById('scanner').focus();
                verificarConflictosAlInicio();
            } else { showToast("Contraseña incorrecta", "error"); document.getElementById('login-pass').value=''; }
        }).catch(e => showToast("Error conexión", "error"));
    }

    // --- INVENTARIO: CARGA Y EDICIÓN ---
    db.collection("inventario").onSnapshot(snap => {
        inventario = []; const tbody = document.getElementById('inv-body'); tbody.innerHTML = '';
        const dl = document.getElementById('lista-provs'); dl.innerHTML = '';
        snap.forEach(doc => {
            const p = doc.data(); p.id = doc.id; inventario.push(p);
            dl.innerHTML += `<option value="${p.proveedor}">`;
            tbody.innerHTML += `
                <tr>
                    <td class="small text-secondary">${p.codigo}</td>
                    <td class="text-white fw-bold">${p.nombre}</td>
                    <td>${p.proveedor}</td>
                    <td>${p.stock}</td>
                    <td class="text-neon">S/ ${p.precio}</td>
                    <td><button class="btn btn-sm btn-outline-secondary border-0" onclick="abrirEditar('${p.id}')"><i class="bi bi-pencil-fill"></i></button></td>
                </tr>`;
        });
    });

    function abrirEditar(id) {
        const p = inventario.find(i => i.id === id);
        if(!p) return;
        document.getElementById('modal-overlay').classList.add('active');
        document.getElementById('modal-titulo').innerText = "EDITAR PRODUCTO";
        document.getElementById('n-id-edit').value = p.id;
        document.getElementById('n-codigo').value = p.codigo;
        document.getElementById('n-nombre').value = p.nombre;
        document.getElementById('n-prov').value = p.proveedor;
        document.getElementById('n-costo').value = p.costo;
        document.getElementById('n-precio').value = p.precio;
        document.getElementById('n-stock').value = p.stock;
    }

    function modalNuevo(cod) {
        document.getElementById('modal-overlay').classList.add('active');
        document.getElementById('modal-titulo').innerText = "NUEVO PRODUCTO";
        document.getElementById('n-id-edit').value = ""; // Limpiar ID para modo nuevo
        document.getElementById('n-codigo').value = cod || "";
        document.getElementById('n-nombre').value = "";
        document.getElementById('n-prov').value = "";
        document.getElementById('n-costo').value = "";
        document.getElementById('n-precio').value = "";
        document.getElementById('n-stock').value = "1";
    }

    function guardarProducto() {
        const idEdit = document.getElementById('n-id-edit').value;
        const p = {
            codigo: document.getElementById('n-codigo').value,
            nombre: document.getElementById('n-nombre').value,
            proveedor: document.getElementById('n-prov').value,
            costo: Number(document.getElementById('n-costo').value),
            precio: Number(document.getElementById('n-precio').value),
            stock: Number(document.getElementById('n-stock').value)
        };
        if(!p.nombre || !p.precio) return showToast("Faltan datos", "error");

        if(idEdit) {
            // EDICIÓN
            db.collection("inventario").doc(idEdit).update(p).then(() => { closeModal(); showToast("Producto Editado"); });
        } else {
            // NUEVO
            db.collection("inventario").add(p).then(() => { closeModal(); showToast("Producto Creado"); });
        }
    }
    function closeModal(){ document.getElementById('modal-overlay').classList.remove('active'); }

    // --- DASHBOARD: REPORTES FILTRADOS ---
    async function generarReporte() {
        const dStart = document.getElementById('dash-desde').value;
        const dEnd = document.getElementById('dash-hasta').value;
        
        if(!dStart || !dEnd) return showToast("Selecciona fechas primero", "error");
        
        showToast("Generando reporte...", "info");
        const start = new Date(dStart + "T00:00:00");
        const end = new Date(dEnd + "T23:59:59");
        
        try {
            const snap = await db.collection("ventas").where("fecha", ">=", start).where("fecha", "<=", end).orderBy("fecha", "desc").get();
            const tbody = document.getElementById('dash-report-body');
            tbody.innerHTML = "";
            let totalPeriodo = 0;
            const counts = {};

            if(snap.empty) {
                tbody.innerHTML = "<tr><td colspan='4' class='text-center'>No hay ventas en este periodo</td></tr>";
                updateChart({});
                document.getElementById('dash-periodo-total').innerText = "0.00";
                return;
            }

            snap.forEach(doc => {
                const v = doc.data();
                const d = v.fecha.toDate();
                totalPeriodo += v.total;
                counts[v.nombre] = (counts[v.nombre] || 0) + v.cantidad;
                tbody.innerHTML += `<tr><td class="small">${d.toLocaleDateString()}</td><td>${v.nombre}</td><td>${v.cantidad}</td><td class="text-neon">${v.total.toFixed(2)}</td></tr>`;
            });
            
            document.getElementById('dash-periodo-total').innerText = totalPeriodo.toFixed(2);
            updateChart(counts);
            showToast("Reporte generado con éxito");

        } catch(e) { console.error(e); showToast("Error generando reporte: " + e.message, "error"); }
    }

    let myChart;
    function updateChart(data) {
        const ctx = document.getElementById('chartProds');
        if(!ctx) return;
        const lbls = Object.keys(data).sort((a,b)=>data[b]-data[a]).slice(0,5);
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'bar', data: { labels: lbls, datasets: [{ label: 'Unidades', data: lbls.map(k=>data[k]), backgroundColor: '#39ff14' }] }, options: { plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} } });
    }

    // --- REALTIME STATS (GLOBAL) ---
    db.collection("ventas").orderBy("fecha", "desc").limit(20).onSnapshot(snap => {
        const tb = document.getElementById('ventas-body'); tb.innerHTML = '';
        let hoy=0, tot=0, cant=0; const dHoy = new Date().toDateString();
        snap.forEach(doc => {
            const v = doc.data(); const d = v.fecha.toDate ? v.fecha.toDate() : new Date(v.fecha);
            tot += v.total;
            if(d.toDateString() === dHoy) { hoy += v.total; cant += v.cantidad; }
            tb.innerHTML += `<tr><td class="small text-secondary">${d.toLocaleDateString()}</td><td>${v.vendedor}</td><td>${v.nombre}</td><td class="text-neon">${v.total}</td><td><i class="bi bi-trash text-danger" onclick="if(confirm('Eliminar?')) db.collection('ventas').doc('${doc.id}').delete()"></i></td></tr>`;
        });
        document.getElementById('d-hist').innerText = tot.toFixed(2);
        document.getElementById('d-hoy').innerText = hoy.toFixed(2);
        document.getElementById('d-count').innerText = cant;
    });

    // --- FUNCIONES CORE (POS, SYNC, ETC) ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    function nav(id, el) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('oculto'));
        document.getElementById('sec-'+id).classList.remove('oculto');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('sidebar').classList.remove('active');
        if(id === 'pos') document.getElementById('scanner').focus();
    }
    
    // Scanner
    const scP = document.getElementById('scanner');
    scP.addEventListener('keydown', (e) => { if(e.key==='Enter') { e.preventDefault(); procesarScanPos(); } });
    function procesarScanPos() {
        const cod = scP.value.trim(); if(!cod) return; scP.value='';
        const p = inventario.find(i => i.codigo === cod);
        if(p) { 
            const ex = carrito.find(i => i.codigo === p.codigo);
            if(ex) ex.cantidad++; else carrito.push({...p, cantidad:1, precio:Number(p.precio)});
            renderCart(); showToast("Agregado: "+p.nombre);
        } else { if(confirm("¿Registrar nuevo?")) modalNuevo(cod); else scP.focus(); }
    }
    function renderCart(){ const t = document.getElementById('cart-body'); t.innerHTML=''; let tot=0; carrito.forEach((p,i)=>{ tot+=p.cantidad*p.precio; t.innerHTML+=`<tr><td>${p.nombre}</td><td>${p.cantidad}</td><td>${p.precio}</td><td class="text-neon">${(p.cantidad*p.precio).toFixed(2)}</td><td><i class="bi bi-x-circle text-danger" onclick="carrito.splice(${i},1);renderCart()"></i></td></tr>`; }); document.getElementById('total-lbl').innerText=tot.toFixed(2); }

    const scE = document.getElementById('scanner-entrada');
    scE.addEventListener('keydown', (e) => { if(e.key==='Enter') { e.preventDefault(); procesarScanEntrada(); } });
    function procesarScanEntrada() {
        const cod = scE.value.trim(); if(!cod) return; scE.value='';
        const p = inventario.find(i => i.codigo === cod);
        if(p) { db.collection("inventario").doc(p.id).update({stock: Number(p.stock)+1}); document.getElementById('msg-entrada').innerHTML=`<b class="text-neon">${p.nombre}</b> (+1)`; }
        else { document.getElementById('msg-entrada').innerText="Nuevo..."; modalNuevo(cod); }
    }

    function finalizar(tipo) {
        if(carrito.length === 0) return showToast("Vacío", "error");
        const tot = carrito.reduce((a,b)=>a+(b.cantidad*b.precio),0);
        const codV = "V-"+Date.now().toString().slice(-6);
        if(tipo === 'cotizar') { generarPDF('cotizar', carrito, tot, codV); return; }
        if(confirm("¿Confirmar?")) {
            const batch = db.batch();
            const itemsS = carrito.map(i=>({codigo:i.codigo, nombre:i.nombre, cantidad:i.cantidad, precio:i.precio}));
            carrito.forEach(i => {
                batch.set(db.collection("ventas").doc(), {fecha:new Date(), vendedor:usuarioActual.nombre, nombre:i.nombre, cantidad:i.cantidad, total:i.cantidad*i.precio});
                const inv = inventario.find(p=>p.codigo===i.codigo); if(inv) batch.update(db.collection("inventario").doc(inv.id), {stock:Number(inv.stock)-i.cantidad});
            });
            batch.commit().then(() => {
                fetch(APPS_SCRIPT_URL, {method:'POST', body:JSON.stringify({action:"venta", items:itemsS, vendedor:usuarioActual.nombre})});
                generarPDF('venta', carrito, tot, codV); showToast("Venta Exitosa"); carrito=[]; renderCart();
            });
        }
    }
    
    // PDF
    function generarPDF(tipo, items, total, codigo) {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFillColor(10,10,10); doc.rect(0,0,210,40,'F'); doc.setTextColor(57,255,20); doc.setFontSize(22); doc.text("GARAJE '89",105,20,null,null,"center");
        doc.setTextColor(0,0,0); doc.setFontSize(10); doc.text(`COD: ${codigo}`,15,50); doc.text(`FECHA: ${new Date().toLocaleString()}`,15,56);
        const body = items.map(i=>[i.nombre, i.cantidad, `S/ ${i.precio}`, `S/ ${i.cantidad*i.precio}`]);
        doc.autoTable({startY:65, head:[['ITEM','CANT','UNIT','TOTAL']], body:body, theme:'grid', headStyles:{fillColor:[0,0,0]}});
        doc.setFontSize(14); doc.text(`TOTAL: S/ ${total.toFixed(2)}`,195,doc.lastAutoTable.finalY+10,null,null,"right");
        doc.save(`${codigo}.pdf`);
    }

    // SYNC
    async function verificarConflictosAlInicio() {
        try {
            const res = await fetch(APPS_SCRIPT_URL, {method:'POST', body:JSON.stringify({action:"leerInventario"})});
            const sData = await res.json(); const snap = await db.collection("inventario").get();
            const fData = []; snap.forEach(d=>fData.push({...d.data(), fid:d.id}));
            cambiosPendientes = []; const conf = [];
            sData.forEach(s => {
                const f = fData.find(x=>x.codigo===String(s.codigo));
                if(f) { if(Number(f.stock)!==Number(s.stock) || Number(f.precio)!==Number(s.precio)) conf.push({tipo:'DIF', codigo:s.codigo, nombre:s.nombre, fire:f, sheet:s, fid:f.fid, dataFull:s}); }
                else conf.push({tipo:'NEW', codigo:s.codigo, nombre:s.nombre, fire:"NO EXISTE", sheet:s, dataFull:s});
            });
            if(conf.length>0) { 
                const tb = document.getElementById('lista-conflictos'); tb.innerHTML='';
                conf.forEach(c => tb.innerHTML+=`<tr><td>${c.nombre}</td><td class="text-neon">${c.fire==="NO EXISTE"?"--":c.fire.stock}</td><td class="text-warning">${c.sheet.stock}</td></tr>`);
                document.getElementById('modal-conflicto').classList.add('active'); cambiosPendientes=conf;
            } else showToast("Sincronizado");
        } catch(e) { console.error(e); }
    }
    function resolverConflicto(d) {
        document.getElementById('modal-conflicto').classList.remove('active');
        if(d==='SHEETS') {
            const b = db.batch();
            cambiosPendientes.forEach(c => {
                if(c.tipo==='NEW') b.set(db.collection("inventario").doc(), {...c.dataFull, costo:Number(c.dataFull.costo), precio:Number(c.dataFull.precio), stock:Number(c.dataFull.stock)});
                else b.update(db.collection("inventario").doc(c.fid), {precio:Number(c.dataFull.precio), stock:Number(c.dataFull.stock)});
            });
            b.commit().then(()=>showToast("Actualizado con Sheets"));
        }
    }
    function syncFirebaseToSheets() {
        if(confirm("¿Sobrescribir Excel con datos de la Web?")) {
            showToast("Enviando...");
            db.collection("inventario").get().then(snap => {
                const l=[]; snap.forEach(d=>l.push(d.data()));
                fetch(APPS_SCRIPT_URL, {method:'POST', body:JSON.stringify({action:"sobreescribirInventario", lista:l})}).then(()=>showToast("Excel Actualizado"));
            });
        }
    }
    function syncSheetsToFirebase() { if(confirm("¿Traer datos del Excel?")) verificarConflictosAlInicio(); }
    
    function crearUser() {
        const id=document.getElementById('u-id').value, p=document.getElementById('u-pass').value;
        if(id&&p) db.collection("usuarios").doc(id).set({nombre:document.getElementById('u-nom').value, contraseña:p, permisos:{rol:document.getElementById('u-rol').value}}).then(()=>showToast("Usuario creado"));
    }
    db.collection("usuarios").onSnapshot(s => { document.getElementById('users-list').innerHTML = s.docs.map(d=>`<div class="user-card"><b>${d.data().nombre}</b> <small>${d.data().permisos.rol}</small></div>`).join(''); });

    function filtrarInv() {
        const t = document.getElementById('search-inv').value.toLowerCase(), p = document.getElementById('filtro-prov').value;
        const r = document.getElementById('inv-body').getElementsByTagName('tr');
        for(let row of r) row.style.display = (row.innerText.toLowerCase().includes(t) && (p==='TODOS'||row.cells[2].innerText===p)) ? '' : 'none';
    }
</script>
</body>
</html>