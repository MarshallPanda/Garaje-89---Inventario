<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garaje '89 Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --neon: #39ff14; --dark: #050505; --panel: rgba(30, 30, 30, 0.6); --border: rgba(57, 255, 20, 0.2); }
        body { background-color: var(--dark); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; margin:0; background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%); }
        
        /* ESTILOS GLOBALES */
        .oculto { display: none !important; }
        .text-neon { color: var(--neon) !important; text-shadow: 0 0 5px rgba(57,255,20,0.5); }
        .glass-panel { background: var(--panel); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 20px; }
        
        /* INPUTS & BOTONES */
        .input-neon { background: rgba(0,0,0,0.5); border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; width: 100%; transition: 0.3s; }
        .input-neon:focus { outline: none; border-color: var(--neon); box-shadow: 0 0 8px rgba(57,255,20,0.3); }
        
        .btn-neon { background: var(--neon); color: black; font-weight: 800; border: none; padding: 10px 20px; border-radius: 6px; width: 100%; text-transform: uppercase; transition: 0.3s; cursor: pointer; }
        .btn-neon:hover { background: #32d911; box-shadow: 0 0 15px var(--neon); transform: scale(1.02); }
        
        .btn-outline { background: transparent; border: 1px solid var(--neon); color: var(--neon); padding: 8px 15px; border-radius: 6px; transition: 0.3s; cursor: pointer; }
        .btn-outline:hover { background: var(--neon); color: black; }

        /* SIDEBAR */
        .sidebar { position: fixed; height: 100vh; width: 260px; background: rgba(10,10,10,0.95); border-right: 1px solid var(--border); padding-top: 30px; z-index: 1000; }
        .brand { font-size: 2rem; font-weight: 900; text-align: center; margin-bottom: 40px; letter-spacing: 3px; font-style: italic; }
        .nav-item { padding: 15px 25px; color: #888; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; font-size: 1.1rem; }
        .nav-item:hover, .nav-item.active { color: var(--neon); background: rgba(57,255,20,0.05); border-left: 4px solid var(--neon); }
        
        .main-content { margin-left: 260px; padding: 40px; }

        /* TABLAS */
        .table-custom { width: 100%; border-collapse: collapse; color: #ccc; }
        .table-custom th { text-align: left; padding: 15px; color: var(--neon); border-bottom: 1px solid #444; }
        .table-custom td { padding: 15px; border-bottom: 1px solid #222; }
        .table-custom tr:hover { background: rgba(255,255,255,0.03); }

        /* LOGIN */
        .login-overlay { position: fixed; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: rgba(20,20,20,0.95); width: 350px; padding: 40px; border-radius: 15px; border: 1px solid var(--border); text-align: center; box-shadow: 0 0 50px rgba(57,255,20,0.1); }
        
        /* MODAL FLOTANTE PEQUE√ëO */
        .modal-overlay { position: fixed; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 5000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #151515; width: 400px; padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.8); animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* LOADER DISCRETO */
        .loader-bar { position: fixed; top: 0; left: 0; height: 3px; background: var(--neon); z-index: 99999; width: 0%; transition: width 0.3s; box-shadow: 0 0 10px var(--neon); }

        /* USUARIOS LISTA */
        .user-card { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-radius: 6px; }

        @media print { .sidebar, .no-print { display: none; } .main-content { margin: 0; padding: 0; } body { background: white; color: black; } }
    </style>
</head>
<body>

    <div id="loader-bar" class="loader-bar"></div>

    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h1 class="brand text-neon">GARAJE '89</h1>
            <p class="text-secondary mb-4">Selecciona tu usuario</p>
            <select id="login-user" class="input-neon mb-3" style="text-align: center; font-size: 1.1rem;"></select>
            <input type="password" id="login-pass" class="input-neon mb-4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align: center;">
            <button onclick="login()" class="btn-neon">ENTRAR</button>
        </div>
    </div>

    <div id="app-container" class="oculto">
        <div class="sidebar no-print">
            <div class="brand text-neon">GARAJE '89</div>
            <div class="nav-item active" onclick="nav('pos', this)"><i class="bi bi-cart2"></i> Vender</div>
            <div class="nav-item" onclick="nav('entrada', this)"><i class="bi bi-box-arrow-in-down"></i> Entradas</div>
            <div class="nav-item" onclick="nav('inv', this)"><i class="bi bi-boxes"></i> Inventario</div>
            
            <div class="admin-only">
                <hr style="border-color:#333; margin:20px">
                <div class="nav-item" onclick="nav('dash', this)"><i class="bi bi-bar-chart-fill"></i> Dashboard</div>
                <div class="nav-item" onclick="nav('ventas', this)"><i class="bi bi-receipt-cutoff"></i> Historial</div>
                <div class="nav-item" onclick="nav('users', this)"><i class="bi bi-people-fill"></i> Usuarios</div>
            </div>
            
            <div style="position: absolute; bottom: 30px; width: 100%; text-align: center;">
                <span id="user-display" class="text-neon fw-bold"></span><br>
                <a href="#" onclick="location.reload()" style="color:#666; font-size:0.8rem; text-decoration:none;">Cerrar Sesi√≥n</a>
            </div>
        </div>

        <div class="main-content">
            
            <div id="sec-pos" class="view-section">
                <h3 class="mb-4 text-white"><i class="bi bi-cart2 text-neon"></i> PUNTO DE VENTA</h3>
                <div class="glass-panel">
                    <input id="scanner" class="input-neon" style="font-size:1.5rem; letter-spacing:2px" placeholder="üî´ Escanear c√≥digo..." autofocus>
                </div>
                <div class="glass-panel">
                    <table class="table-custom">
                        <thead><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th><th></th></thead>
                        <tbody id="cart-body"></tbody>
                    </table>
                    <div class="d-flex justify-content-between align-items-end mt-4 pt-3 border-top border-secondary">
                        <div class="text-start">
                            <button onclick="finalizar('cotizar')" class="btn-outline me-2"><i class="bi bi-file-earmark-pdf"></i> COTIZAR</button>
                        </div>
                        <div class="text-end">
                            <h5 class="text-secondary">Total a Pagar</h5>
                            <h1 class="text-neon display-4 fw-bold">S/ <span id="total-lbl">0.00</span></h1>
                            <button onclick="finalizar('venta')" class="btn-neon mt-2 px-5">VENDER</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-entrada" class="view-section oculto">
                <h3 class="mb-4 text-white">ENTRADAS R√ÅPIDAS</h3>
                <div class="glass-panel text-center py-5">
                    <div style="font-size:4rem; color:var(--neon); margin-bottom:20px"><i class="bi bi-box-seam-fill"></i></div>
                    <h5>Escanea para sumar <span class="text-neon">+1</span> al stock</h5>
                    <input id="scanner-entrada" class="input-neon mx-auto mt-4" style="max-width:400px; text-align:center; font-size:1.2rem" placeholder="Esperando c√≥digo...">
                    <p id="msg-entrada" class="mt-3 text-secondary">Listo.</p>
                </div>
            </div>

            <div id="sec-inv" class="view-section oculto">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-white">INVENTARIO</h3>
                    <button class="btn-neon" style="width:auto" onclick="modalNuevo('')"><i class="bi bi-plus-lg"></i> Nuevo</button>
                </div>
                <div class="glass-panel">
                    <div class="d-flex gap-2 mb-3">
                        <select id="filtro-prov" class="input-neon" onchange="filtrarInv()"></select>
                        <button class="btn-outline" onclick="cargarInv()"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div style="max-height: 65vh; overflow-y: auto;">
                        <table class="table-custom">
                            <thead><th>Cod</th><th>Nombre</th><th>Prov</th><th>Stock</th><th>Precio</th></thead>
                            <tbody id="inv-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sec-dash" class="view-section oculto">
                <h3 class="mb-4 text-white">ESTAD√çSTICAS</h3>
                <div class="row g-4 mb-4">
                    <div class="col-md-6"><div class="glass-panel">
                        <h6 class="text-secondary">Ventas Totales</h6>
                        <h2 class="text-neon">S/ <span id="d-hist">0.00</span></h2>
                    </div></div>
                    <div class="col-md-6"><div class="glass-panel">
                        <h6 class="text-secondary">Vendido Hoy</h6>
                        <h2 class="text-white">S/ <span id="d-hoy">0.00</span></h2>
                    </div></div>
                </div>
                <div class="glass-panel">
                    <h5 class="mb-4">Top 5 Productos Vendidos</h5>
                    <canvas id="chartProds" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div id="sec-ventas" class="view-section oculto">
                <h3 class="mb-4 text-white">HISTORIAL VENTAS</h3>
                <button class="btn-outline mb-3" onclick="cargarVentas()">Actualizar</button>
                <div class="glass-panel">
                    <table class="table-custom"><thead><th>Fecha</th><th>Vend</th><th>Prod</th><th>Total (Edit)</th><th></th></thead><tbody id="ventas-body"></tbody></table>
                </div>
            </div>

            <div id="sec-users" class="view-section oculto">
                <div class="row">
                    <div class="col-md-5">
                        <div class="glass-panel">
                            <h5 class="text-neon mb-3">Crear Usuario</h5>
                            <input id="u-id" class="input-neon mb-2" placeholder="ID (ej: juan)">
                            <input id="u-nom" class="input-neon mb-2" placeholder="Nombre Completo">
                            <input id="u-pass" class="input-neon mb-2" type="password" placeholder="Contrase√±a">
                            <select id="u-rol" class="input-neon mb-3"><option value="trabajador">Trabajador</option><option value="admin">Administrador</option></select>
                            <button class="btn-neon" onclick="crearUser()">GUARDAR</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="glass-panel">
                            <h5 class="mb-3">Usuarios Existentes</h5>
                            <div id="users-list" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay oculto">
        <div class="modal-box">
            <h5 class="text-neon text-center mb-3">NUEVO PRODUCTO</h5>
            <input id="n-codigo" class="input-neon mb-2" readonly style="opacity:0.7">
            <input id="n-nombre" class="input-neon mb-2" placeholder="Nombre del Producto">
            <select id="n-prov" class="input-neon mb-2" onchange="checkOtro(this)"></select>
            <input id="n-prov-txt" class="input-neon mb-2 oculto" placeholder="Nuevo Proveedor">
            <div class="d-flex gap-2 mb-2">
                <input id="n-costo" type="number" class="input-neon" placeholder="Costo">
                <input id="n-precio" type="number" class="input-neon" placeholder="Precio">
            </div>
            <input id="n-stock" type="number" class="input-neon mb-3" value="1" placeholder="Stock">
            <div class="d-flex gap-2">
                <button class="btn-outline" onclick="cerrarModal()">CANCELAR</button>
                <button class="btn-neon" onclick="guardarNuevo()">GUARDAR</button>
            </div>
        </div>
    </div>

<script>
    // --- ‚ö†Ô∏è‚ö†Ô∏è PEGA TU URL DE APPS SCRIPT AQU√ç ‚ö†Ô∏è‚ö†Ô∏è ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyxBQpIK46_VtCiXmtOwsnQvhGM_OIy2k0lM5_KfROrzjJIMHhPSeDq_ZZiHQXJsCY/exec";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBzUErnjQEGE9-neDh5z6VJ_xNaHRmAkew",
        authDomain: "garaje89-inventario.firebaseapp.com",
        projectId: "garaje89-inventario",
        storageBucket: "garaje89-inventario.firebasestorage.app",
        messagingSenderId: "538336429741",
        appId: "1:538336429741:web:0f7ce96f624f3568a8e824"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let usuarioActual = null, carrito = [], inventarioCache = [];

    // LOADER
    function loading(show) { document.getElementById('loader-bar').style.width = show ? '100%' : '0%'; setTimeout(()=>document.getElementById('loader-bar').style.width='0%', 500); }

    async function callAPI(action, payload = {}) {
        loading(true);
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) });
            return await res.json();
        } catch (e) { console.error(e); return null; }
    }

    // INICIO
    window.onload = function() {
        const sel = document.getElementById('login-user');
        db.collection("usuarios").get().then(s => {
            sel.innerHTML = '<option value="">Selecciona tu usuario</option>';
            s.forEach(d => {
                let data = d.data();
                let o = document.createElement('option');
                o.value = d.id; o.innerText = data.nombre;
                sel.appendChild(o);
                // Listar en secci√≥n usuarios
                document.getElementById('users-list').innerHTML += `<div class="user-card"><span>${data.nombre} <small class="text-secondary">(${data.permisos.rol})</small></span></div>`;
            });
        });
    };

    function login() {
        let u = document.getElementById('login-user').value;
        let p = document.getElementById('login-pass').value;
        if(!u || !p) return;
        
        db.collection("usuarios").doc(u).get().then(doc => {
            if(doc.exists && doc.data().contrase√±a === p) {
                usuarioActual = doc.data(); usuarioActual.id = doc.id;
                document.getElementById('login-overlay').classList.add('oculto');
                document.getElementById('app-container').classList.remove('oculto');
                document.getElementById('user-display').innerText = usuarioActual.nombre;
                if(usuarioActual.permisos.rol !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('oculto'));
                cargarProvModal();
            } else { alert("Contrase√±a incorrecta"); }
        });
    }

    function nav(id, el) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('oculto'));
        document.getElementById('sec-'+id).classList.remove('oculto');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        if(id==='pos') document.getElementById('scanner').focus();
        if(id==='entrada') document.getElementById('scanner-entrada').focus();
        if(id==='inv') cargarInv();
        if(id==='ventas') cargarVentas();
        if(id==='dash') cargarDash();
    }

    // POS
    document.getElementById('scanner').addEventListener('keypress', async function(e){
        if(e.key==='Enter'){
            let c = this.value; this.value='';
            const r = await callAPI('escanear', { codigo: c });
            if(r && r.status==='encontrado') addCar(r.producto);
            else if(confirm("‚ö†Ô∏è Producto nuevo. ¬øRegistrar?")) modalNuevo(c);
        }
    });

    function addCar(p){
        let ex = carrito.find(x=>x.codigo===p.codigo);
        if(ex) ex.cantidad++; else carrito.push({...p, cantidad:1, precio:Number(p.precio)});
        renderCar();
    }
    function renderCar(){
        let h='', t=0;
        carrito.forEach((p,i)=>{
            t+=p.cantidad*p.precio;
            h+=`<tr><td>${p.nombre}</td><td>${p.cantidad}</td><td>S/ ${p.precio}</td><td>S/ ${(p.cantidad*p.precio).toFixed(2)}</td><td><button class="btn-outline" style="border-color:red; color:red; padding:2px 8px" onclick="del(${i})"><i class="bi bi-trash"></i></button></td></tr>`;
        });
        document.getElementById('cart-body').innerHTML=h;
        document.getElementById('total-lbl').innerText=t.toFixed(2);
    }
    function del(i){ carrito.splice(i,1); renderCar(); }
    async function finalizar(t){
        if(carrito.length===0) return;
        if(t==='venta'){
            if(!confirm("¬øProcesar venta?")) return;
            await callAPI('venta', {vendedor:usuarioActual.nombre, items:carrito});
            alert("Venta Exitosa");
        }
        window.print(); carrito=[]; renderCar();
    }

    // ENTRADAS
    document.getElementById('scanner-entrada').addEventListener('keypress', async function(e){
        if(e.key==='Enter'){
            let c = this.value; this.value='';
            document.getElementById('msg-entrada').innerText = "Procesando...";
            const r = await callAPI('entradaStock', {codigo:c});
            if(r.status==='actualizado'){
                document.getElementById('msg-entrada').innerText = `‚úÖ Agregado: ${r.producto.nombre} (Stock: ${r.producto.nuevo_stock})`;
                document.getElementById('msg-entrada').className = "mt-3 text-neon";
            } else modalNuevo(c);
        }
    });

    // INVENTARIO & MODAL
    async function cargarInv(){ const d = await callAPI('leerInventario'); if(d) { inventarioCache=d; filtrarInv(); cargarProvModal(); } }
    function filtrarInv(){
        let f = document.getElementById('filtro-prov').value, h = '';
        inventarioCache.forEach(r=>{ if(f==='TODOS' || r[2]===f) h+=`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[5]}</td><td>${r[4]}</td></tr>`; });
        document.getElementById('inv-body').innerHTML=h;
    }
    function modalNuevo(c){ document.getElementById('modal-overlay').classList.remove('oculto'); document.getElementById('n-codigo').value=c||''; cargarProvModal(); }
    function cerrarModal(){ document.getElementById('modal-overlay').classList.add('oculto'); }
    async function cargarProvModal(){
        const l = await callAPI('leerProveedores');
        if(!l) return;
        let s = document.getElementById('filtro-prov'); s.innerHTML='<option value="TODOS">Todos</option>';
        let m = document.getElementById('n-prov'); m.innerHTML='<option value="">Seleccionar...</option><option value="OTRO">‚ûï Nuevo</option>';
        l.forEach(p=>{ s.innerHTML+=`<option value="${p}">${p}</option>`; m.innerHTML+=`<option value="${p}">${p}</option>`; });
    }
    function checkOtro(s){ if(s.value==='OTRO') { document.getElementById('n-prov-txt').classList.remove('oculto'); document.getElementById('n-prov-txt').focus(); } else document.getElementById('n-prov-txt').classList.add('oculto'); }
    async function guardarNuevo(){
        let p = document.getElementById('n-prov').value; if(p==='OTRO') p = document.getElementById('n-prov-txt').value;
        let f = { codigo:document.getElementById('n-codigo').value, nombre:document.getElementById('n-nombre').value, proveedor:p, costo:document.getElementById('n-costo').value, precio:document.getElementById('n-precio').value, stock:document.getElementById('n-stock').value };
        await callAPI('guardarProducto', {form:f});
        cerrarModal(); cargarInv();
    }

    // ADMIN & DASH
    async function cargarVentas(){
        const d = await callAPI('leerVentas');
        let h=''; d.forEach(r=>{ h+=`<tr><td>${new Date(r[1]).toLocaleDateString()}</td><td>${r[2]}</td><td>${r[4]}</td><td><input class="input-neon" style="width:70px; padding:2px" value="${r[7]}" onchange="editV('${r[0]}',this.value)"></td><td><button class="btn-outline" style="border-color:red; color:red; padding:2px" onclick="delV('${r[0]}')">X</button></td></tr>`; });
        document.getElementById('ventas-body').innerHTML=h;
    }
    async function editV(id,v){ await callAPI('editarVenta', {id, total:v}); }
    async function delV(id){ if(confirm("¬øEliminar?")) { await callAPI('eliminarVenta', {id}); cargarVentas(); } }
    
    let myChart;
    async function cargarDash(){
        const d = await callAPI('dashboard');
        document.getElementById('d-hist').innerText = d.totalHistorico.toFixed(2);
        document.getElementById('d-hoy').innerText = d.totalHoy.toFixed(2);
        
        // GR√ÅFICO
        const ctx = document.getElementById('chartProds').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: d.topProductos.map(p => p.name),
                datasets: [{
                    label: 'Unidades Vendidas',
                    data: d.topProductos.map(p => p.count),
                    backgroundColor: 'rgba(57, 255, 20, 0.5)',
                    borderColor: '#39ff14',
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true, grid: { color: '#333' } }, x: { grid: { color: '#333' } } }, plugins: { legend: { labels: { color: 'white' } } } }
        });
    }

    function crearUser(){
        let i=document.getElementById('u-id').value; let n=document.getElementById('u-nom').value; let p=document.getElementById('u-pass').value; let r=document.getElementById('u-rol').value;
        db.collection("usuarios").doc(i).set({nombre:n, contrase√±a:p, permisos:{rol:r}}).then(()=>{ alert("Usuario Creado"); location.reload(); });
    }
</script>
</body>
</html>